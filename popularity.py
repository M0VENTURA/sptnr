[full content of popularity.py as in previous attachment]