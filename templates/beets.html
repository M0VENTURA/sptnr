{% extends "base.html" %}

{% block title %}Metadata - Sptnr{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-music-note"></i> Metadata</h1>
      <p class="text-secondary">Organize and tag your music library automatically</p>
    </div>
  </div>

  <!-- Status Section -->
  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Status</h5>
        </div>
        <div class="card-body">
          <div id="beetsStatusSpinner" class="spinner-border mb-2" role="status" style="display: none;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div id="beetsStatus"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-database"></i> Library Statistics</h5>
        </div>
        <div class="card-body">
          <div id="beetsStatsSpinner" class="spinner-border mb-2" role="status" style="display: none;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div id="beetsStats"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Section -->
  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-lightning"></i> Auto-Import Library</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Auto-import entire library with MusicBrainz tagging. Captures metadata and stores recommendations in database.</p>
          
          <div class="mb-3">
            <label for="autoImportArtist" class="form-label">Artist Path (Optional)</label>
            <input 
              type="text" 
              class="form-control" 
              id="autoImportArtist" 
              placeholder="Leave empty for full library, or /music/Artist Name"
            >
            <small class="form-text">Import specific artist only, or leave empty for entire library</small>
          </div>

          <button type="button" class="btn btn-success btn-lg w-100 mb-2" onclick="startAutoImport()">
            <i class="bi bi-play-fill"></i> Start Auto-Import (beet import -A)
          </button>
          
          <button type="button" class="btn btn-info w-100" onclick="syncBeetsMetadata()">
            <i class="bi bi-arrow-repeat"></i> Sync Beets Metadata to Database
          </button>
          
          <div id="autoImportStatus" style="display: none; margin-top: 1rem;">
            <div class="alert alert-info">
              <i class="bi bi-hourglass-split"></i>
              <span id="autoImportMessage">Starting auto-import...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-cloud-download"></i> Manual Import</h5>
        </div>
        <div class="card-body">
          <form id="beetsImportForm">
            <div class="mb-3">
              <label for="importPath" class="form-label">Source Path</label>
              <input 
                type="text" 
                class="form-control" 
                id="importPath" 
                placeholder="/path/to/music/files"
                required
              >
              <small class="form-text">Path to music files to import</small>
            </div>

            <div class="mb-3">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="importMove" 
                  checked
                >
                <label class="form-check-label" for="importMove">
                  Move files (vs. copy)
                </label>
              </div>
              <small class="form-text">Check to move files, uncheck to copy</small>
            </div>

            <button type="submit" class="btn btn-primary">
              <i class="bi bi-play-fill"></i> Start Import
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetBeetsImportForm()">
              <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
          </form>
          
          <div id="importStatus" style="display: none; margin-top: 1rem;">
            <div class="alert alert-info">
              <i class="bi bi-hourglass-split"></i> 
              <span id="importMessage">Preparing import...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuration Section -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-gear"></i> Configuration</h5>
        </div>
        <div class="card-body">
          <p class="text-secondary">Beets configuration controls how music is imported and organized.</p>
          
          <button type="button" class="btn btn-primary" onclick="createBeetsConfig()">
            <i class="bi bi-wrench"></i> Create Default Configuration
          </button>
          
          <div id="configStatus" style="display: none; margin-top: 1rem;">
            <div class="alert alert-success">
              <i class="bi bi-check-circle"></i>
              Default beets configuration created
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let beetsStatusInterval;

function loadBeetsStatus() {
  // Show spinner
  document.getElementById('beetsStatusSpinner').style.display = 'inline-block';
  document.getElementById('beetsStatsSpinner').style.display = 'inline-block';
  
  fetch('/api/beets/status')
    .then(r => r.json())
    .then(data => {
      const status = data.status || {};
      const stats = data.stats || {};
      
      let statusHtml = `
        <div class="metadata-row">
          <span class="metadata-label">Status:</span>
          <span class="metadata-value">
            ${status.enabled ? '<span class="badge bg-success">Enabled</span>' : '<span class="badge bg-secondary">Disabled</span>'}
          </span>
        </div>
        <div class="metadata-row">
          <span class="metadata-label">Installed:</span>
          <span class="metadata-value">
            ${status.installed ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-danger">No</span>'}
          </span>
        </div>
        <div class="metadata-row">
          <span class="metadata-label">Config:</span>
          <span class="metadata-value">
            ${status.config_exists ? '<span class="badge bg-success">Exists</span>' : '<span class="badge bg-warning">Missing</span>'}
          </span>
        </div>
        <div class="metadata-row">
          <span class="metadata-label">Library DB:</span>
          <span class="metadata-value">
            ${status.library_db_exists ? '<span class="badge bg-success">Exists</span>' : '<span class="badge bg-warning">Missing</span>'}
          </span>
        </div>
      `;
      
      // Hide spinner and show content
      document.getElementById('beetsStatusSpinner').style.display = 'none';
      document.getElementById('beetsStatus').innerHTML = statusHtml;
      
      // Load stats
      let statsHtml = '';
      if (stats.success) {
        statsHtml = `
          <div class="metadata-row">
            <span class="metadata-label">Tracks:</span>
            <span class="metadata-value">${stats.track_count || 0}</span>
          </div>
          <div class="metadata-row">
            <span class="metadata-label">Library:</span>
            <span class="metadata-value" style="word-break: break-all; font-size: 0.85rem;">
              ${stats.library_path || 'N/A'}
            </span>
          </div>
        `;
      } else {
        statsHtml = '<p class="text-muted">Unable to load library statistics</p>';
      }
      
      // Hide spinner and show content
      document.getElementById('beetsStatsSpinner').style.display = 'none';
      document.getElementById('beetsStats').innerHTML = statsHtml;
    })
    .catch(e => {
      console.error('Error loading beets status:', e);
      document.getElementById('beetsStatusSpinner').style.display = 'none';
      document.getElementById('beetsStatsSpinner').style.display = 'none';
      document.getElementById('beetsStatus').innerHTML = '<p class="text-danger">Error loading status</p>';
      document.getElementById('beetsStats').innerHTML = '<p class="text-danger">Error loading statistics</p>';
    });
}

document.getElementById('beetsImportForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const sourcePath = document.getElementById('importPath').value;
  const move = document.getElementById('importMove').checked;
  
  if (!sourcePath) {
    alert('Please enter a source path');
    return;
  }
  
  // Show status
  document.getElementById('noImportStatus').style.display = 'none';
  document.getElementById('importStatus').style.display = 'block';
  document.getElementById('importSuccess').style.display = 'none';
  document.getElementById('importError').style.display = 'none';
  
  fetch('/api/beets/import', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      source_path: sourcePath,
      move: move
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById('importStatus').style.display = 'none';
      document.getElementById('importSuccess').style.display = 'block';
      document.getElementById('importSuccessMessage').textContent = data.message;
      
      // Reload status after delay
      setTimeout(loadBeetsStatus, 2000);
    } else {
      document.getElementById('importStatus').style.display = 'none';
      document.getElementById('importError').style.display = 'block';
      document.getElementById('importErrorMessage').textContent = data.error || 'Import failed';
    }
  })
  .catch(e => {
    document.getElementById('importStatus').style.display = 'none';
    document.getElementById('importError').style.display = 'block';
    document.getElementById('importErrorMessage').textContent = 'Network error: ' + e.message;
  });
});

function resetBeetsImportForm() {
  document.getElementById('beetsImportForm').reset();
  document.getElementById('noImportStatus').style.display = 'block';
  document.getElementById('importStatus').style.display = 'none';
  document.getElementById('importSuccess').style.display = 'none';
  document.getElementById('importError').style.display = 'none';
}

function createBeetsConfig() {
  fetch('/api/beets/configure', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById('configStatus').style.display = 'block';
      setTimeout(loadBeetsStatus, 1000);
    } else {
      alert('Error: ' + (data.error || 'Failed to create configuration'));
    }
  })
  .catch(e => alert('Network error: ' + e.message));
}

function startAutoImport() {
  const artistPath = document.getElementById('autoImportArtist').value.trim();
  
  if (confirm(`Start auto-import${artistPath ? ' for ' + artistPath : ' for entire library'}?\n\nThis will run 'beet import -A' and capture MusicBrainz metadata.`)) {
    document.getElementById('autoImportStatus').style.display = 'block';
    document.getElementById('autoImportMessage').textContent = 'Starting auto-import...';
    
    fetch('/api/beets/auto-import', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ artist_path: artistPath || null })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById('autoImportMessage').textContent = data.message + ' - Check console for progress';
        setTimeout(() => {
          document.getElementById('autoImportStatus').style.display = 'none';
          loadBeetsStatus();
        }, 5000);
      } else {
        document.getElementById('autoImportStatus').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-circle"></i> ${data.error || 'Auto-import failed'}
          </div>
        `;
      }
    })
    .catch(e => {
      document.getElementById('autoImportStatus').innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle"></i> Network error: ${e.message}
        </div>
      `;
    });
  }
}

function syncBeetsMetadata() {
  if (confirm('Sync metadata from beets database to sptnr database?\n\nThis will update tracks with MusicBrainz IDs and recommendations from beets.')) {
    document.getElementById('autoImportStatus').style.display = 'block';
    document.getElementById('autoImportMessage').textContent = 'Syncing beets metadata...';
    
    fetch('/api/beets/sync-metadata', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById('autoImportStatus').innerHTML = `
          <div class="alert alert-success">
            <i class="bi bi-check-circle"></i> ${data.message}
          </div>
        `;
        setTimeout(() => {
          document.getElementById('autoImportStatus').style.display = 'none';
        }, 3000);
      } else {
        document.getElementById('autoImportStatus').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-circle"></i> ${data.error || 'Sync failed'}
          </div>
        `;
      }
    })
    .catch(e => {
      document.getElementById('autoImportStatus').innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle"></i> Network error: ${e.message}
        </div>
      `;
    });
  }
}


// Load status on page load
document.addEventListener('DOMContentLoaded', function() {
  loadBeetsStatus();
  beetsStatusInterval = setInterval(loadBeetsStatus, 10000); // Refresh every 10 seconds
});

// Clean up on page unload
window.addEventListener('unload', function() {
  if (beetsStatusInterval) clearInterval(beetsStatusInterval);
});
</script>
{% endblock %}
