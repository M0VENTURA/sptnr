{% extends "base.html" %}

{% block title %}Smart Playlist Creator{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">üéµ Smart Playlist Creator</h1>
            <p class="text-muted">Create dynamic playlists that automatically update based on criteria like rating, play count, date added, and more.</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-spotify-green text-white">
                    <h5 class="mb-0">Create New Smart Playlist</h5>
                </div>
                <div class="card-body">
                    <form id="smartPlaylistForm">
                        <!-- Basic Info Section -->
                        <div class="section-header mb-4">
                            <h6 class="text-spotify-green">üìã Playlist Details</h6>
                        </div>

                        <div class="form-group mb-3">
                            <label for="playlistName" class="form-label">Playlist Name *</label>
                            <input type="text" class="form-control" id="playlistName" placeholder="e.g., Recently Played" required>
                            <small class="form-text text-muted">The name of your smart playlist</small>
                        </div>

                        <div class="form-group mb-3">
                            <label for="fileName" class="form-label">File Name (without .nsp) *</label>
                            <input type="text" class="form-control" id="fileName" placeholder="e.g., recently_played" required>
                            <small class="form-text text-muted">Will be saved as .nsp file in /Music/Playlists</small>
                        </div>

                        <div class="form-group mb-3">
                            <label for="playlistComment" class="form-label">Description</label>
                            <textarea class="form-control" id="playlistComment" rows="2" placeholder="Optional description of the playlist"></textarea>
                        </div>

                        <hr>

                        <!-- Filter Section -->
                        <div class="section-header mb-4">
                            <h6 class="text-spotify-green">üîç Filters (All conditions must match)</h6>
                            <small class="text-muted">Add multiple filters - all must be satisfied</small>
                        </div>

                        <div id="filtersList" class="mb-4">
                            <div class="filter-group card mb-3 p-3" data-filter-id="0">
                                <div class="row align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label">Field</label>
                                        <select class="form-control filter-field" onchange="updateOperators(this)">
                                            <option value="">Select Field</option>
                                            <optgroup label="Basic Info">
                                                <option value="title">Title</option>
                                                <option value="album">Album</option>
                                                <option value="artist">Artist</option>
                                                <option value="albumartist">Album Artist</option>
                                                <option value="genre">Genre</option>
                                            </optgroup>
                                            <optgroup label="Rating & Playback">
                                                <option value="rating">Rating</option>
                                                <option value="playcount">Play Count</option>
                                                <option value="loved">Loved</option>
                                                <option value="lastplayed">Last Played</option>
                                            </optgroup>
                                            <optgroup label="Dates">
                                                <option value="year">Year</option>
                                                <option value="dateadded">Date Added</option>
                                                <option value="datemodified">Date Modified</option>
                                                <option value="dateloved">Date Loved</option>
                                                <option value="daterated">Date Rated</option>
                                            </optgroup>
                                            <optgroup label="Technical">
                                                <option value="duration">Duration</option>
                                                <option value="bitrate">Bitrate</option>
                                                <option value="bitdepth">Bit Depth</option>
                                                <option value="bpm">BPM</option>
                                                <option value="tracknumber">Track Number</option>
                                                <option value="discnumber">Disc Number</option>
                                                <option value="compilation">Compilation</option>
                                                <option value="hascoverart">Has Cover Art</option>
                                            </optgroup>
                                            <optgroup label="Other">
                                                <option value="comment">Comment</option>
                                                <option value="filepath">File Path</option>
                                                <option value="library_id">Library ID</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Operator</label>
                                        <select class="form-control filter-operator">
                                            <option value="">Select Operator</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Value</label>
                                        <input type="text" class="form-control filter-value" placeholder="Enter value">
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeFilter(this)">Remove Filter</button>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-secondary mb-4" onclick="addFilter()">+ Add Another Filter</button>

                        <hr>

                        <!-- Sorting Section -->
                        <div class="section-header mb-4">
                            <h6 class="text-spotify-green">‚ÜïÔ∏è Sorting</h6>
                        </div>

                        <div class="form-group mb-3">
                            <label for="sortField" class="form-label">Sort By</label>
                            <select class="form-control" id="sortField">
                                <option value="">None</option>
                                <option value="title">Title</option>
                                <option value="album">Album</option>
                                <option value="artist">Artist</option>
                                <option value="rating">Rating</option>
                                <option value="playcount">Play Count</option>
                                <option value="lastplayed">Last Played</option>
                                <option value="year">Year</option>
                                <option value="dateadded">Date Added</option>
                                <option value="duration">Duration</option>
                                <option value="random">Random</option>
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label for="sortOrder" class="form-label">Sort Order</label>
                            <select class="form-control" id="sortOrder">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>

                        <hr>

                        <!-- Limit Section -->
                        <div class="section-header mb-4">
                            <h6 class="text-spotify-green">üìä Limit</h6>
                        </div>

                        <div class="form-group mb-4">
                            <label for="playlistLimit" class="form-label">Maximum Tracks</label>
                            <input type="number" class="form-control" id="playlistLimit" min="0" placeholder="Leave empty for no limit" value="">
                            <small class="form-text text-muted">Maximum number of tracks to include (0 or empty = no limit)</small>
                        </div>

                        <!-- Preview Section -->
                        <hr>
                        <div class="section-header mb-4">
                            <h6 class="text-spotify-green">üëÅÔ∏è JSON Preview</h6>
                        </div>

                        <pre id="jsonPreview" class="bg-dark text-light p-3 rounded mb-4" style="max-height: 300px; overflow-y: auto;">{}</pre>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                            <button type="button" class="btn btn-info" onclick="copyJSON()">üìã Copy JSON</button>
                            <button type="submit" class="btn btn-success btn-lg">‚úÖ Create Playlist</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">‚ÑπÔ∏è Help & Examples</h6>
                </div>
                <div class="card-body">
                    <h6 class="text-spotify-green mb-3">Common Use Cases</h6>
                    
                    <div class="example-card mb-3 p-2 bg-light rounded">
                        <strong>Recently Played</strong>
                        <small>
                            <p class="mb-2">Last played in the last 30 days</p>
                            <button type="button" class="btn btn-xs btn-sm btn-outline-primary" onclick="loadExample('recently_played')">Load</button>
                        </small>
                    </div>

                    <div class="example-card mb-3 p-2 bg-light rounded">
                        <strong>Favourites</strong>
                        <small>
                            <p class="mb-2">All loved tracks sorted by date</p>
                            <button type="button" class="btn btn-xs btn-sm btn-outline-primary" onclick="loadExample('favourites')">Load</button>
                        </small>
                    </div>

                    <div class="example-card mb-3 p-2 bg-light rounded">
                        <strong>80's Top Hits</strong>
                        <small>
                            <p class="mb-2">Loved tracks or rating > 3 from 1980-1990</p>
                            <button type="button" class="btn btn-xs btn-sm btn-outline-primary" onclick="loadExample('80s_hits')">Load</button>
                        </small>
                    </div>

                    <div class="example-card mb-3 p-2 bg-light rounded">
                        <strong>High-Rated Songs</strong>
                        <small>
                            <p class="mb-2">Songs with rating > 4, sorted by rating</p>
                            <button type="button" class="btn btn-xs btn-sm btn-outline-primary" onclick="loadExample('high_rated')">Load</button>
                        </small>
                    </div>

                    <div class="example-card mb-3 p-2 bg-light rounded">
                        <strong>Random Selection</strong>
                        <small>
                            <p class="mb-2">Random songs from your library</p>
                            <button type="button" class="btn btn-xs btn-sm btn-outline-primary" onclick="loadExample('random')">Load</button>
                        </small>
                    </div>

                    <hr>

                    <h6 class="text-spotify-green mb-3">Operator Guide</h6>
                    <small>
                        <table class="table table-sm table-bordered">
                            <tbody>
                                <tr>
                                    <td><strong>is</strong></td>
                                    <td>Equals (text/number)</td>
                                </tr>
                                <tr>
                                    <td><strong>isNot</strong></td>
                                    <td>Not equals</td>
                                </tr>
                                <tr>
                                    <td><strong>gt</strong></td>
                                    <td>Greater than</td>
                                </tr>
                                <tr>
                                    <td><strong>lt</strong></td>
                                    <td>Less than</td>
                                </tr>
                                <tr>
                                    <td><strong>contains</strong></td>
                                    <td>Contains text</td>
                                </tr>
                                <tr>
                                    <td><strong>startsWith</strong></td>
                                    <td>Starts with</td>
                                </tr>
                                <tr>
                                    <td><strong>inTheRange</strong></td>
                                    <td>Range (min,max)</td>
                                </tr>
                                <tr>
                                    <td><strong>inTheLast</strong></td>
                                    <td>In last X days</td>
                                </tr>
                            </tbody>
                        </table>
                    </small>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">üìö About Smart Playlists</h6>
                </div>
                <div class="card-body">
                    <small>
                        <p><strong>Smart Playlists</strong> are dynamic playlists stored as `.nsp` files that automatically update based on criteria you define.</p>
                        <p class="mb-2"><strong>Features:</strong></p>
                        <ul>
                            <li>Automatic updates when criteria change</li>
                            <li>Complex filtering rules</li>
                            <li>Custom sorting options</li>
                            <li>Works across all Navidrome clients</li>
                        </ul>
                        <p class="mb-0">For more info, see the <a href="https://www.navidrome.org/docs/usage/smartplaylists/" target="_blank">Navidrome documentation</a></p>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto">‚úÖ Success</strong>
        </div>
        <div class="toast-body" id="successMessage"></div>
    </div>
    <div id="errorToast" class="toast" role="alert">
        <div class="toast-header bg-danger text-white">
            <strong class="me-auto">‚ùå Error</strong>
        </div>
        <div class="toast-body" id="errorMessage"></div>
    </div>
</div>

<style>
    .section-header {
        border-bottom: 2px solid var(--spotify-green);
        padding-bottom: 0.5rem;
    }

    .filter-group {
        border-left: 3px solid var(--spotify-green);
        background-color: var(--secondary-bg);
    }

    .example-card {
        border-left: 3px solid var(--spotify-green);
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .example-card:hover {
        background-color: #e8f5e9 !important;
    }

    #jsonPreview {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.4;
    }

    .btn-xs {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
</style>

<script>
// Operator mappings for different field types
const operatorMap = {
    // String fields
    'title': ['is', 'isNot', 'contains', 'notContains', 'startsWith', 'endsWith'],
    'album': ['is', 'isNot', 'contains', 'notContains', 'startsWith', 'endsWith'],
    'artist': ['is', 'isNot', 'contains', 'notContains', 'startsWith', 'endsWith'],
    'albumartist': ['is', 'isNot', 'contains', 'notContains', 'startsWith', 'endsWith'],
    'genre': ['is', 'isNot', 'contains', 'notContains', 'startsWith', 'endsWith'],
    'comment': ['is', 'isNot', 'contains', 'notContains', 'startsWith', 'endsWith'],
    'filepath': ['is', 'isNot', 'contains', 'notContains', 'startsWith', 'endsWith'],
    
    // Numeric fields
    'rating': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'playcount': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'duration': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'bitrate': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'bitdepth': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'bpm': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'tracknumber': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'discnumber': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'library_id': ['is', 'isNot', 'gt', 'lt', 'inTheRange'],
    'year': ['is', 'isNot', 'gt', 'lt', 'inTheRange', 'inTheLast'],
    
    // Date fields
    'dateadded': ['before', 'after', 'inTheLast', 'notInTheLast'],
    'datemodified': ['before', 'after', 'inTheLast', 'notInTheLast'],
    'dateloved': ['before', 'after', 'inTheLast', 'notInTheLast'],
    'daterated': ['before', 'after', 'inTheLast', 'notInTheLast'],
    'lastplayed': ['before', 'after', 'inTheLast', 'notInTheLast'],
    
    // Boolean fields
    'loved': ['is'],
    'compilation': ['is'],
    'hascoverart': ['is']
};

// Examples data
const examples = {
    'recently_played': {
        name: 'Recently Played',
        comment: 'Tracks played in the last 30 days',
        filters: [{ field: 'lastplayed', operator: 'inTheLast', value: '30' }],
        sort: 'lastplayed',
        order: 'desc',
        limit: 100
    },
    'favourites': {
        name: 'Favourites',
        comment: 'All loved tracks sorted by date loved',
        filters: [{ field: 'loved', operator: 'is', value: 'true' }],
        sort: 'dateloved',
        order: 'desc',
        limit: 500
    },
    '80s_hits': {
        name: "80's Top Hits",
        comment: 'Top songs from the 1980s',
        filters: [
            { field: 'year', operator: 'inTheRange', value: '1980,1989' }
        ],
        sort: 'rating',
        order: 'desc',
        limit: 50
    },
    'high_rated': {
        name: 'High-Rated Songs',
        comment: 'Songs with rating greater than 3',
        filters: [{ field: 'rating', operator: 'gt', value: '3' }],
        sort: 'rating',
        order: 'desc',
        limit: 200
    },
    'random': {
        name: 'Random Selection',
        comment: 'Random songs from your library',
        filters: [],
        sort: 'random',
        order: 'asc',
        limit: 100
    }
};

let filterCounter = 1;

function updateOperators(selectElement) {
    const filterGroup = selectElement.closest('.filter-group');
    const field = selectElement.value;
    const operatorSelect = filterGroup.querySelector('.filter-operator');
    
    operatorSelect.innerHTML = '<option value="">Select Operator</option>';
    
    if (field && operatorMap[field]) {
        operatorMap[field].forEach(op => {
            const option = document.createElement('option');
            option.value = op;
            option.textContent = op;
            operatorSelect.appendChild(option);
        });
    }
}

function addFilter() {
    const filtersList = document.getElementById('filtersList');
    const filterId = filterCounter++;
    const newFilter = document.createElement('div');
    newFilter.className = 'filter-group card mb-3 p-3';
    newFilter.setAttribute('data-filter-id', filterId);
    newFilter.innerHTML = `
        <div class="row align-items-end">
            <div class="col-md-4">
                <label class="form-label">Field</label>
                <select class="form-control filter-field" onchange="updateOperators(this)">
                    <option value="">Select Field</option>
                    <optgroup label="Basic Info">
                        <option value="title">Title</option>
                        <option value="album">Album</option>
                        <option value="artist">Artist</option>
                        <option value="albumartist">Album Artist</option>
                        <option value="genre">Genre</option>
                    </optgroup>
                    <optgroup label="Rating & Playback">
                        <option value="rating">Rating</option>
                        <option value="playcount">Play Count</option>
                        <option value="loved">Loved</option>
                        <option value="lastplayed">Last Played</option>
                    </optgroup>
                    <optgroup label="Dates">
                        <option value="year">Year</option>
                        <option value="dateadded">Date Added</option>
                        <option value="datemodified">Date Modified</option>
                        <option value="dateloved">Date Loved</option>
                        <option value="daterated">Date Rated</option>
                    </optgroup>
                    <optgroup label="Technical">
                        <option value="duration">Duration</option>
                        <option value="bitrate">Bitrate</option>
                        <option value="bitdepth">Bit Depth</option>
                        <option value="bpm">BPM</option>
                        <option value="tracknumber">Track Number</option>
                        <option value="discnumber">Disc Number</option>
                        <option value="compilation">Compilation</option>
                        <option value="hascoverart">Has Cover Art</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="comment">Comment</option>
                        <option value="filepath">File Path</option>
                        <option value="library_id">Library ID</option>
                    </optgroup>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Operator</label>
                <select class="form-control filter-operator">
                    <option value="">Select Operator</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Value</label>
                <input type="text" class="form-control filter-value" placeholder="Enter value">
            </div>
        </div>
        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-danger" onclick="removeFilter(this)">Remove Filter</button>
        </div>
    `;
    filtersList.appendChild(newFilter);
}

function removeFilter(button) {
    const filterGroup = button.closest('.filter-group');
    filterGroup.remove();
    updateJsonPreview();
}

function buildJSON() {
    const json = {};
    
    const name = document.getElementById('playlistName').value;
    const comment = document.getElementById('playlistComment').value;
    
    if (name) json.name = name;
    if (comment) json.comment = comment;
    
    // Build filters
    const filters = [];
    document.querySelectorAll('.filter-group').forEach(group => {
        const field = group.querySelector('.filter-field').value;
        const operator = group.querySelector('.filter-operator').value;
        const value = group.querySelector('.filter-value').value;
        
        if (field && operator && value) {
            const filter = {};
            const filterObj = {};
            
            // Parse value based on operator
            let parsedValue = value;
            
            if (operator === 'inTheRange') {
                const parts = value.split(',').map(v => v.trim());
                parsedValue = parts.map(v => isNaN(v) ? v : parseInt(v));
            } else if (operator === 'is' && (value === 'true' || value === 'false')) {
                parsedValue = value === 'true';
            } else if (['rating', 'playcount', 'duration', 'bitrate', 'bitdepth', 'bpm', 'tracknumber', 'discnumber', 'year', 'library_id'].includes(field) && !isNaN(value) && operator !== 'contains' && operator !== 'startsWith' && operator !== 'endsWith' && operator !== 'notContains') {
                parsedValue = parseInt(value);
            } else if (operator === 'inTheLast' || operator === 'notInTheLast') {
                parsedValue = parseInt(value);
            }
            
            filterObj[field] = {};
            filterObj[field][operator] = parsedValue;
            filter[operator === 'inTheLast' || operator === 'notInTheLast' ? operator : (operator.includes('inThe') ? operator : operator)] = filterObj[field][operator];
            
            // Correct structure
            const correctFilter = {};
            correctFilter[operator] = {};
            correctFilter[operator][field] = parsedValue;
            filters.push(correctFilter);
        }
    });
    
    if (filters.length > 0) {
        json.all = filters;
    }
    
    // Add sort
    const sortField = document.getElementById('sortField').value;
    if (sortField) {
        json.sort = sortField;
    }
    
    // Add order (only if not random)
    if (sortField && sortField !== 'random') {
        json.order = document.getElementById('sortOrder').value;
    }
    
    // Add limit
    const limit = document.getElementById('playlistLimit').value;
    if (limit && parseInt(limit) > 0) {
        json.limit = parseInt(limit);
    }
    
    return json;
}

function updateJsonPreview() {
    const json = buildJSON();
    document.getElementById('jsonPreview').textContent = JSON.stringify(json, null, 2);
}

function resetForm() {
    document.getElementById('smartPlaylistForm').reset();
    document.getElementById('filtersList').innerHTML = `
        <div class="filter-group card mb-3 p-3" data-filter-id="0">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Field</label>
                    <select class="form-control filter-field" onchange="updateOperators(this)">
                        <option value="">Select Field</option>
                        <optgroup label="Basic Info">
                            <option value="title">Title</option>
                            <option value="album">Album</option>
                            <option value="artist">Artist</option>
                            <option value="albumartist">Album Artist</option>
                            <option value="genre">Genre</option>
                        </optgroup>
                        <optgroup label="Rating & Playback">
                            <option value="rating">Rating</option>
                            <option value="playcount">Play Count</option>
                            <option value="loved">Loved</option>
                            <option value="lastplayed">Last Played</option>
                        </optgroup>
                        <optgroup label="Dates">
                            <option value="year">Year</option>
                            <option value="dateadded">Date Added</option>
                            <option value="datemodified">Date Modified</option>
                            <option value="dateloved">Date Loved</option>
                            <option value="daterated">Date Rated</option>
                        </optgroup>
                        <optgroup label="Technical">
                            <option value="duration">Duration</option>
                            <option value="bitrate">Bitrate</option>
                            <option value="bitdepth">Bit Depth</option>
                            <option value="bpm">BPM</option>
                            <option value="tracknumber">Track Number</option>
                            <option value="discnumber">Disc Number</option>
                            <option value="compilation">Compilation</option>
                            <option value="hascoverart">Has Cover Art</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="comment">Comment</option>
                            <option value="filepath">File Path</option>
                            <option value="library_id">Library ID</option>
                        </optgroup>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Operator</label>
                    <select class="form-control filter-operator">
                        <option value="">Select Operator</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Value</label>
                    <input type="text" class="form-control filter-value" placeholder="Enter value">
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeFilter(this)">Remove Filter</button>
            </div>
        </div>
    `;
    filterCounter = 1;
    updateJsonPreview();
}

function loadExample(exampleKey) {
    const example = examples[exampleKey];
    if (!example) return;
    
    document.getElementById('playlistName').value = example.name;
    document.getElementById('playlistComment').value = example.comment || '';
    document.getElementById('sortField').value = example.sort || '';
    document.getElementById('sortOrder').value = example.order || 'asc';
    document.getElementById('playlistLimit').value = example.limit || '';
    
    // Clear existing filters
    document.getElementById('filtersList').innerHTML = '';
    filterCounter = 0;
    
    // Add filters from example
    example.filters.forEach(filter => {
        addFilter();
        const lastFilter = document.querySelector('.filter-group:last-child');
        lastFilter.querySelector('.filter-field').value = filter.field;
        updateOperators(lastFilter.querySelector('.filter-field'));
        lastFilter.querySelector('.filter-operator').value = filter.operator;
        lastFilter.querySelector('.filter-value').value = filter.value;
    });
    
    updateJsonPreview();
}

function copyJSON() {
    const json = document.getElementById('jsonPreview').textContent;
    navigator.clipboard.writeText(json).then(() => {
        showToast('success', 'JSON copied to clipboard!');
    }).catch(() => {
        showToast('error', 'Failed to copy JSON');
    });
}

function showToast(type, message) {
    const toastId = type === 'success' ? 'successToast' : 'errorToast';
    const messageId = type === 'success' ? 'successMessage' : 'errorMessage';
    
    document.getElementById(messageId).textContent = message;
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
}

document.getElementById('smartPlaylistForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileName = document.getElementById('fileName').value.trim();
    if (!fileName) {
        showToast('error', 'Please enter a file name');
        return;
    }
    
    const json = buildJSON();
    
    if (!json.name) {
        showToast('error', 'Please enter a playlist name');
        return;
    }
    
    try {
        const response = await fetch('/api/smartplaylist/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fileName: fileName,
                playlist: json
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('success', `Playlist "${json.name}" created successfully!`);
            resetForm();
        } else {
            showToast('error', data.error || 'Failed to create playlist');
        }
    } catch (error) {
        showToast('error', 'Error creating playlist: ' + error.message);
    }
});

// Update preview when any field changes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('filter-field') || 
        e.target.classList.contains('filter-operator') || 
        e.target.classList.contains('filter-value') ||
        e.target.id === 'playlistName' ||
        e.target.id === 'playlistComment' ||
        e.target.id === 'sortField' ||
        e.target.id === 'sortOrder' ||
        e.target.id === 'playlistLimit') {
        updateJsonPreview();
    }
});

// Initialize preview
updateJsonPreview();
</script>
{% endblock %}
