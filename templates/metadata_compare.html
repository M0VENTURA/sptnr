{% extends "base.html" %}

{% block title %}Metadata Comparison - Popularr{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-diagram-3"></i> Metadata Comparison</h1>
      <p class="text-secondary">Compare Navidrome and Beets metadata for albums with mismatches</p>
    </div>
  </div>

  {% if album_comparisons %}
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Album Mismatches ({{ album_comparisons|length }} albums)</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 35%;">Album</th>
                    <th style="width: 20%;">Artist</th>
                    <th style="width: 15%;">Tracks</th>
                    <th style="width: 30%;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for comp in album_comparisons %}
                  <tr>
                    <td>
                      <strong>{{ comp.album }}</strong>
                    </td>
                    <td>{{ comp.artist }}</td>
                    <td>
                      <span class="badge bg-secondary">{{ comp.track_count }} tracks</span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-info" 
                              onclick="expandComparison(this, '{{ comp.artist|escape }}', '{{ comp.album|escape }}')"
                              data-bs-toggle="collapse" 
                              data-bs-target="#compare-{{ loop.index }}">
                        <i class="bi bi-chevron-down"></i> Compare
                      </button>
                    </td>
                  </tr>
                  <!-- Expandable comparison row -->
                  <tr id="compare-{{ loop.index }}" class="collapse">
                    <td colspan="4">
                      <div class="p-4 bg-light">
                        <div class="row">
                          <div class="col-md-6">
                            <div class="card border-info">
                              <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="bi bi-music-note"></i> Navidrome Data</h6>
                              </div>
                              <div class="card-body">
                                <p class="mb-2">
                                  <strong>Album:</strong> {{ comp.album }}<br>
                                  <strong>Artist:</strong> {{ comp.artist }}<br>
                                  <strong>Year:</strong> <span class="badge bg-info">{{ comp.navidrome.year or 'N/A' }}</span>
                                </p>
                                {% if comp.navidrome.genres %}
                                <div class="mb-3">
                                  <strong>Genres:</strong>
                                  <div class="mt-2">
                                    {% for genre in comp.navidrome.genres %}
                                      {% if genre %}
                                      <span class="badge bg-info">{{ genre }}</span>
                                      {% endif %}
                                    {% endfor %}
                                  </div>
                                </div>
                                {% endif %}
                                <button class="btn btn-sm btn-success" 
                                        onclick="acceptNavidromeData('{{ comp.artist|escape }}', '{{ comp.album|escape }}')">
                                  <i class="bi bi-check-circle"></i> Keep This Data
                                </button>
                              </div>
                            </div>
                          </div>

                          <div class="col-md-6">
                            <div class="card border-warning">
                              <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="bi bi-disc"></i> Beets Data</h6>
                              </div>
                              <div class="card-body">
                                <p class="mb-2">
                                  <strong>Album:</strong> {{ comp.album }}<br>
                                  <strong>Artist:</strong> {{ comp.artist }}<br>
                                  <strong>Year:</strong> <span class="badge bg-warning text-dark">{{ comp.beets.year or 'N/A' }}</span>
                                </p>
                                {% if comp.beets.genres %}
                                <div class="mb-3">
                                  <strong>Genres:</strong>
                                  <div class="mt-2">
                                    {% for genre in comp.beets.genres %}
                                      {% if genre %}
                                      <span class="badge bg-warning text-dark">{{ genre }}</span>
                                      {% endif %}
                                    {% endfor %}
                                  </div>
                                </div>
                                {% endif %}
                                <button class="btn btn-sm btn-primary" 
                                        onclick="searchMusicBrainz('{{ comp.artist|escape }}', '{{ comp.album|escape }}')">
                                  <i class="bi bi-search"></i> Search for Better Match
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- MusicBrainz Search Results -->
                        <div id="mb-results-{{ loop.index }}" class="mt-4" style="display: none;">
                          <div class="card border-success">
                            <div class="card-header bg-success text-white">
                              <h6 class="mb-0"><i class="bi bi-search"></i> MusicBrainz Search Results</h6>
                            </div>
                            <div class="card-body">
                              <div id="mb-results-content-{{ loop.index }}"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="row">
      <div class="col-12">
        <div class="alert alert-success" role="alert">
          <i class="bi bi-check-circle"></i> <strong>No mismatches found!</strong>
          <p class="mb-0 mt-2">All albums have matching metadata between Navidrome and Beets.</p>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- MusicBrainz Search Modal -->
<div class="modal fade" id="mbSearchModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-search"></i> Search MusicBrainz
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="mbSearchResults"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
function expandComparison(btn, artist, album) {
  // Button will toggle the collapse automatically
}

function searchMusicBrainz(artist, album) {
  const modal = new bootstrap.Modal(document.getElementById('mbSearchModal'));
  const resultDiv = document.getElementById('mbSearchResults');
  resultDiv.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
  
  fetch('/api/metadata-compare/search-musicbrainz', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      artist: artist,
      album: album
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
      return;
    }

    if (!data.results || data.results.length === 0) {
      resultDiv.innerHTML = `
        <div class="alert alert-warning">
          <p>No matches found on MusicBrainz for "${artist} - ${album}"</p>
          <button class="btn btn-primary" onclick="submitNewToMusicBrainz('${artist}', '${album}')">
            <i class="bi bi-plus-circle"></i> Submit as New Item
          </button>
        </div>
      `;
      return;
    }

    let html = '<div class="list-group">';
    data.results.forEach((result, idx) => {
      const year = result['first-release-date'] ? result['first-release-date'].split('-')[0] : 'N/A';
      const genresHtml = (result.genres && result.genres.length > 0) 
        ? `<div class="mb-2"><strong>Genres:</strong> ${result.genres.map(g => `<span class="badge bg-secondary">${g}</span>`).join(' ')}</div>`
        : '';
      
      const resultJson = JSON.stringify(result).replace(/'/g, "\\'").replace(/"/g, '&quot;');
      
      html += `
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">${result.title || result.album || 'Unknown'}</h6>
              <p class="mb-1 text-muted">
                <strong>Artist:</strong> ${result['artist-credit'] || result.artist || 'Unknown'}<br>
                <strong>Year:</strong> ${year}
              </p>
              ${genresHtml}
            </div>
            <button class="btn btn-sm btn-success" onclick="applyMusicBrainzDataClick('${artist}', '${album}', '${resultJson}')">
              <i class="bi bi-check-circle"></i> Use This
            </button>
          </div>
        </div>
      `;
    });
    html += '</div>';
    resultDiv.innerHTML = html;
  })
  .catch(error => {
    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
  });
  
  modal.show();
}

function applyMusicBrainzDataClick(artist, album, mbDataJson) {
  try {
    const mbData = JSON.parse(mbDataJson);
    applyMusicBrainzData(artist, album, mbData);
  } catch (e) {
    alert('Error parsing MusicBrainz data: ' + e.message);
  }
}

function applyMusicBrainzData(artist, album, mbData) {
  fetch('/api/metadata-compare/apply-musicbrainz', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      artist: artist,
      album: album,
      mb_data: mbData
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('✅ ' + data.message);
      location.reload();
    } else {
      alert('❌ Error: ' + data.error);
    }
  })
  .catch(error => alert('Error: ' + error.message));
}

function acceptNavidromeData(artist, album) {
  if (!confirm(`Lock Navidrome data for "${artist} - ${album}"?\n\nThis will prevent Beets from overwriting this metadata.`)) {
    return;
  }

  fetch('/api/metadata-compare/accept-navidrome', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      artist: artist,
      album: album
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('✅ ' + data.message);
      location.reload();
    } else {
      alert('❌ Error: ' + data.error);
    }
  })
  .catch(error => alert('Error: ' + error.message));
}

function submitNewToMusicBrainz(artist, album) {
  const mbUrl = `https://musicbrainz.org/login?redirect=/release/create?artist-credit.names.0.artist.name=${encodeURIComponent(artist)}&name=${encodeURIComponent(album)}`;
  window.open(mbUrl, '_blank');
}
</script>

<style>
.badge {
  margin-right: 0.25rem;
}
</style>
{% endblock %}
