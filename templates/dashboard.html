{% extends "base.html" %}

{% block title %}Dashboard - Sptnr{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="mb-4">
        <h1 class="h2 mb-1">
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
        <p class="text-muted mb-0">Music library overview and scan controls</p>
    </div>
    
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Dashboard Error:</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    <!-- Statistics Cards -->
    <div class="row g-2 g-md-3 mb-4">
        <div class="col-6 col-sm-4 col-lg-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="stat-label mb-2">
                        <i class="bi bi-people"></i> Artists
                    </div>
                    <div class="h4 mb-0">{{ artist_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-lg-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="stat-label mb-2">
                        <i class="bi bi-disc"></i> Albums
                    </div>
                    <div class="h4 mb-0">{{ album_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-lg-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="stat-label mb-2">
                        <i class="bi bi-music-note"></i> Tracks
                    </div>
                    <div class="h4 mb-0">{{ track_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-lg-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="stat-label mb-2">
                        <i class="bi bi-star-fill"></i> 5★
                    </div>
                    <div class="h4 mb-0">{{ five_star_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-lg-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="stat-label mb-2">
                        <i class="bi bi-single-music"></i> Singles
                    </div>
                    <div class="h4 mb-0">{{ singles_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-lg-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="stat-label mb-2">
                        <i class="bi bi-circle-fill"></i> Status
                    </div>
                    <div class="h5 mb-0">
                        {% if scan_running %}
                            <span class="badge bg-danger">Running</span>
                        {% else %}
                            <span class="badge bg-success">Idle</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scan Controls -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-play-circle"></i> Scan Controls
            </h5>
        </div>
        <div class="card-body">
            {% if scan_running %}
                <span class="badge bg-success d-inline-block mb-3">
                    <i class="bi bi-play-fill"></i> Scan in progress...
                </span>
                
                <!-- Progress Bar -->
                <div class="mt-3" id="scan-progress-container" style="display: none;">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted" id="progress-text">Processing...</small>
                        <small class="text-muted" id="progress-percent">0%</small>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progress-bar" 
                             role="progressbar" 
                             style="width: 0%;" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="progress-details">
                            <span id="current-artist"></span>
                            <span id="current-album"></span>
                        </small>
                    </div>
                    <div class="mt-1">
                        <small class="text-muted" id="progress-phase"></small>
                    </div>
                </div>
                
                <!-- Stop Button -->
                <div class="mt-3">
                    <form method="POST" action="{{ url_for('scan_stop') }}" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="bi bi-stop-circle"></i> Stop Scan
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="d-flex flex-column flex-md-row gap-2 gap-md-3">
                    <form method="POST" action="{{ url_for('scan_unified') }}" class="flex-grow-1">
                        <button type="submit" class="btn btn-success w-100" style="background-color: #1db954; border-color: #1db954; color: #000; font-weight: 600;">
                            <i class="bi bi-play-circle"></i> Start Unified Scan
                        </button>
                    </form>
                    
                    <form method="POST" action="{{ url_for('scan_start') }}" class="flex-grow-1">
                        <input type="hidden" name="scan_type" value="force">
                        <button type="submit" class="btn btn-force w-100">
                            <i class="bi bi-arrow-clockwise"></i> Force Re-scan
                        </button>
                    </form>
                    
                    <a href="{{ url_for('logs') }}" class="btn btn-outline-secondary w-100 flex-grow-1">
                        <i class="bi bi-file-text"></i> Logs
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Detailed Scan Controls -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-sliders"></i> Scan Operations
            </h5>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">Run individual scan operations for more control over the process.</p>
            <div class="d-grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <!-- Navidrome Scan -->
                <div class="scan-card">
                    <div class="d-flex align-items-center mb-2 gap-2">
                        <h6 class="mb-0 flex-grow-1">
                            <i class="bi bi-cloud"></i> Navidrome Sync
                        </h6>
                        <span class="scan-badge" data-scan-type="navidrome_scan" style="display: none;">
                            <span class="badge bg-success" style="font-size: 0.75rem;"><i class="bi bi-play-fill"></i> Running</span>
                        </span>
                    </div>
                    
                    <div class="scan-progress-container" data-scan-type="navidrome_scan" style="display: none;">
                        <div class="progress" style="height: 16px; margin-bottom: 0.5rem;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" style="width: 0%;" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1.3;">
                            <span class="scan-progress-text">Initializing...</span>
                        </small>
                    </div>
                    
                    <div class="btn-group w-100 mt-2" role="group">
                        <form method="POST" action="{{ url_for('scan_navidrome') }}" class="w-50">
                            <button type="submit" class="btn btn-sm btn-primary w-100" style="border-radius: 4px 0 0 4px;">
                                <i class="bi bi-play-fill"></i> Start
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('scan_stop') }}" class="w-50" style="border-left: 1px solid var(--border-color);">
                            <button type="submit" class="btn btn-sm btn-outline-danger w-100" style="border-radius: 0 4px 4px 0; border-left: none;">
                                <i class="bi bi-stop-fill"></i> Stop
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Popularity Scan -->
                <div class="scan-card">
                    <div class="d-flex align-items-center mb-2 gap-2">
                        <h6 class="mb-0 flex-grow-1">
                            <i class="bi bi-graph-up"></i> Popularity Update
                        </h6>
                        <span class="scan-badge" data-scan-type="popularity_scan" style="display: none;">
                            <span class="badge bg-success" style="font-size: 0.75rem;"><i class="bi bi-play-fill"></i> Running</span>
                        </span>
                    </div>
                    
                    <div class="scan-progress-container" data-scan-type="popularity_scan" style="display: none;">
                        <div class="progress" style="height: 16px; margin-bottom: 0.5rem;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" style="width: 0%;" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1.3;">
                            <span class="scan-progress-text">Initializing...</span>
                        </small>
                    </div>
                    
                    <div class="btn-group w-100 mt-2" role="group">
                        <form method="POST" action="{{ url_for('scan_popularity') }}" class="w-50">
                            <button type="submit" class="btn btn-sm btn-primary w-100" style="border-radius: 4px 0 0 4px;">
                                <i class="bi bi-play-fill"></i> Start
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('scan_stop') }}" class="w-50" style="border-left: 1px solid var(--border-color);">
                            <button type="submit" class="btn btn-sm btn-outline-danger w-100" style="border-radius: 0 4px 4px 0; border-left: none;">
                                <i class="bi bi-stop-fill"></i> Stop
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Singles Scan -->
                <div class="scan-card">
                    <div class="d-flex align-items-center mb-2 gap-2">
                        <h6 class="mb-0 flex-grow-1">
                            <i class="bi bi-music-note"></i> Singles Detection
                        </h6>
                        <span class="scan-badge" data-scan-type="singles_scan" style="display: none;">
                            <span class="badge bg-success" style="font-size: 0.75rem;"><i class="bi bi-play-fill"></i> Running</span>
                        </span>
                    </div>
                    
                    <div class="scan-progress-container" data-scan-type="singles_scan" style="display: none;">
                        <div class="progress" style="height: 16px; margin-bottom: 0.5rem;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" style="width: 0%;" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1.3;">
                            <span class="scan-progress-text">Initializing...</span>
                        </small>
                    </div>
                    
                    <div class="btn-group w-100 mt-2" role="group">
                        <form method="POST" action="{{ url_for('scan_singles') }}" class="w-50">
                            <button type="submit" class="btn btn-sm btn-primary w-100" style="border-radius: 4px 0 0 4px;">
                                <i class="bi bi-play-fill"></i> Start
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('scan_stop') }}" class="w-50" style="border-left: 1px solid var(--border-color);">
                            <button type="submit" class="btn btn-sm btn-outline-danger w-100" style="border-radius: 0 4px 4px 0; border-left: none;">
                                <i class="bi bi-stop-fill"></i> Stop
                            </button>
                        </form>
                    </div>
                </div>

                <!-- File Paths Scan -->
                <div class="scan-card">
                    <div class="d-flex align-items-center mb-2 gap-2">
                        <h6 class="mb-0 flex-grow-1">
                            <i class="bi bi-disc"></i> Update File Paths
                        </h6>
                        <span class="scan-badge" data-scan-type="mp3_scan" style="display: none;">
                            <span class="badge bg-success" style="font-size: 0.75rem;"><i class="bi bi-play-fill"></i> Running</span>
                        </span>
                    </div>
                    
                    <div class="scan-progress-container" data-scan-type="mp3_scan" style="display: none;">
                        <div class="progress" style="height: 16px; margin-bottom: 0.5rem;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                 role="progressbar" style="width: 0%;" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1.3;">
                            <span class="scan-progress-text">Initializing...</span>
                        </small>
                    </div>
                    
                    <div class="btn-group w-100 mt-2" role="group">
                        <form method="POST" action="{{ url_for('scan_mp3') }}" class="w-50">
                            <button type="submit" class="btn btn-sm btn-info w-100" style="border-radius: 4px 0 0 4px; color: #000; font-weight: 600;">
                                <i class="bi bi-play-fill"></i> Start
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('scan_stop') }}" class="w-50" style="border-left: 1px solid var(--border-color);">
                            <button type="submit" class="btn btn-sm btn-outline-danger w-100" style="border-radius: 0 4px 4px 0; border-left: none;">
                                <i class="bi bi-stop-fill"></i> Stop
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Scans -->
    {% if recent_scans %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> Recent Scans
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="d-none d-md-table-header-group">
                        <tr>
                            <th>
                                <i class="bi bi-person"></i> Artist
                            </th>
                            <th>
                                <i class="bi bi-disc"></i> Album
                            </th>
                            <th>Last Scanned</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in recent_scans %}
                        <tr class="d-flex flex-column d-md-table-row">
                            <td data-label="Artist" class="d-flex justify-content-between d-md-table-cell">
                                <span class="d-md-none text-muted fw-bold">Artist</span>
                                <a href="{{ url_for('artist_detail', name=scan.artist) }}">
                                    {{ scan.artist }}
                                </a>
                            </td>
                            <td data-label="Album" class="d-flex justify-content-between d-md-table-cell">
                                <span class="d-md-none text-muted fw-bold">Album</span>
                                <a href="{{ url_for('album_detail', artist=scan.artist, album=scan.album) }}">
                                    {{ scan.album }}
                                </a>
                            </td>
                            <td data-label="Scanned" class="d-flex justify-content-between d-md-table-cell text-muted">
                                <span class="d-md-none text-muted fw-bold">Scanned</span>
                                {{ scan.last_scan }}
                            </td>
                            <td class="d-flex justify-content-end d-md-table-cell">
                                <a href="{{ url_for('album_detail', artist=scan.artist, album=scan.album) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
    
    <div class="d-flex flex-column flex-md-row gap-2">
        <a href="{{ url_for('artists') }}" class="btn btn-primary flex-grow-1">
            <i class="bi bi-people"></i> <span class="d-none d-sm-inline">Browse Artists</span>
        </a>
        <a href="{{ url_for('config_editor') }}" class="btn btn-outline-secondary flex-grow-1">
            <i class="bi bi-gear"></i> <span class="d-none d-sm-inline">Settings</span>
        </a>
    </div>
</div>

<style>
    .stat-label {
        font-size: 0.85rem;
        color: var(--text-secondary, #b0b0b0);
        font-weight: 500;
    }

    /* Table and card dark theme fixes */
    .card {
        background-color: var(--secondary-bg, #1e1e1e) !important;
        border-color: var(--border-color, #333) !important;
    }

    .card-header {
        background-color: var(--primary-bg, #121212) !important;
        border-bottom-color: var(--border-color, #333) !important;
    }

    .table-responsive {
        background-color: var(--secondary-bg, #1e1e1e) !important;
    }

    .table {
        color: var(--text-primary, #fff) !important;
        background-color: transparent !important;
    }

    .table thead th {
        color: var(--text-primary, #fff) !important;
        background-color: var(--primary-bg, #121212) !important;
        border-color: var(--border-color, #333) !important;
    }

    .table tbody td {
        color: var(--text-primary, #fff) !important;
        background-color: transparent !important;
        border-color: var(--border-color, #333) !important;
    }

    .table-hover tbody tr:hover {
        background-color: var(--primary-bg, #121212) !important;
    }

    .btn-force {
        background-color: #ff6b00;
        border-color: #ff6b00;
        color: #fff;
        font-weight: 600;
    }

    .btn-force:hover {
        background-color: #ff8000;
        border-color: #ff8000;
        color: #fff;
    }

    .btn-force:active,
    .btn-force:focus {
        background-color: #ff5500;
        border-color: #ff5500;
        box-shadow: 0 0 0 0.25rem rgba(255, 107, 0, 0.5);
    }

    /* Scan card styling */
    .scan-card {
        border: 1px solid var(--border-color, #333);
        border-radius: 6px;
        padding: 1rem;
        background-color: var(--secondary-bg, #1e1e1e);
    }

    .scan-progress-container {
        border-top: 1px solid var(--border-color, #333);
        padding-top: 0.75rem;
    }

    .progress {
        background-color: var(--tertiary-bg, #282828) !important;
    }

    .progress-bar {
        position: relative;
        overflow: hidden;
    }

    .progress-text {
        position: absolute;
        top: 0;
        left: 2px;
        font-size: 0.65rem;
        font-weight: 600;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        line-height: 12px;
    }

    .scan-logs {
        border-top: 1px solid var(--border-color, #333);
        padding-top: 0.5rem;
        font-family: 'Courier New', monospace;
        color: var(--text-tertiary, #a0a0a0);
    }

    .scan-logs small {
        line-height: 1.3;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Poll scan status every 2 seconds
    function updateScanStatus() {
        fetch('/api/scan-status')
            .then(response => response.json())
            .then(data => {
                // Update badge and progress bar visibility based on running status
                document.querySelectorAll('.scan-badge').forEach(badge => {
                    const scanType = badge.getAttribute('data-scan-type');
                    const scanData = data[scanType];
                    
                    if (scanData && scanData.running) {
                        badge.style.display = 'block';
                        
                        // Show progress bar for this scan type
                        const progressBarContainer = document.querySelector(`.scan-progress-bar[data-scan-type="${scanType}"]`);
                        if (progressBarContainer) {
                            progressBarContainer.style.display = 'block';
                        }
                    } else {
                        badge.style.display = 'none';
                        
                        // Hide progress bar for this scan type
                        const progressBarContainer = document.querySelector(`.scan-progress-bar[data-scan-type="${scanType}"]`);
                        if (progressBarContainer) {
                            progressBarContainer.style.display = 'none';
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching scan status:', error));
    }
    
    // Poll individual scan progress every 1 second
    function updateIndividualScanProgress() {
        fetch('/api/scan-progress')
            .then(response => response.json())
            .then(data => {
                if (!data.is_running) return;
                
                const scanType = data.scan_type || 'unified';
                
                // Map scan types to their respective progress bar elements
                const scanTypeMapping = {
                    'mp3_scan': 'mp3_scan',
                    'navidrome_scan': 'navidrome_scan',
                    'popularity_scan': 'popularity_scan',
                    'singles_scan': 'singles_scan'
                };
                
                const mappedScanType = scanTypeMapping[scanType];
                if (!mappedScanType) return;
                
                const progressBarContainer = document.querySelector(`.scan-progress-bar[data-scan-type="${mappedScanType}"]`);
                if (!progressBarContainer) return;
                
                const progressBar = progressBarContainer.querySelector('.progress-bar');
                const progressText = progressBarContainer.querySelector('.scan-progress-text');
                
                let percent = 0;
                let text = 'Processing...';
                
                // Calculate progress based on scan type
                if (scanType === 'mp3_scan' && data.scanned_files && data.total_files) {
                    percent = Math.round((data.scanned_files / data.total_files) * 100);
                    text = `${data.scanned_files}/${data.total_files} files scanned`;
                } else if (scanType === 'navidrome_scan' && data.scanned_albums && data.total_albums) {
                    percent = Math.round((data.scanned_albums / data.total_albums) * 100);
                    text = `${data.scanned_albums}/${data.total_albums} albums`;
                    if (data.current_artist) {
                        text += ` · ${data.current_artist}`;
                    }
                } else if (scanType === 'popularity_scan' && data.processed_artists && data.total_artists) {
                    percent = Math.round((data.processed_artists / data.total_artists) * 100);
                    text = `${data.processed_artists}/${data.total_artists} artists`;
                } else if (scanType === 'singles_scan' && data.processed_artists && data.total_artists) {
                    percent = Math.round((data.processed_artists / data.total_artists) * 100);
                    text = `${data.processed_artists}/${data.total_artists} artists`;
                }
                
                // Update progress bar
                if (progressBar) {
                    progressBar.style.width = percent + '%';
                    progressBar.setAttribute('aria-valuenow', percent);
                }
                
                // Update text with percentage
                if (progressText) {
                    progressText.textContent = `${percent}% · ${text}`;
                }
            })
            .catch(error => console.error('Error fetching scan progress:', error));
    }
    
    // Poll scan progress every 1 second
    function updateScanProgress() {
        fetch('/api/scan-progress')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('scan-progress-container');
                
                if (data.is_running) {
                    // Show progress bar
                    container.style.display = 'block';
                    
                    const scanType = data.scan_type || 'unified';
                    
                    // Handle unified scan
                    if (scanType === 'unified') {
                        // Update progress bar
                        const progressBar = document.getElementById('progress-bar');
                        const percent = Math.round(data.percent_complete || 0);
                        progressBar.style.width = percent + '%';
                        progressBar.setAttribute('aria-valuenow', percent);
                        
                        // Update text
                        document.getElementById('progress-percent').textContent = percent + '%';
                        
                        // Update details
                        const artistText = data.current_artist ? 
                            `<i class="bi bi-person"></i> ${data.current_artist}` : '';
                        const albumText = data.current_album ? 
                            ` → <i class="bi bi-disc"></i> ${data.current_album}` : '';
                        document.getElementById('current-artist').innerHTML = artistText;
                        document.getElementById('current-album').innerHTML = albumText;
                        
                        // Update phase
                        let phaseText = '';
                        if (data.current_phase === 'popularity') {
                            phaseText = '<i class="bi bi-graph-up"></i> Detecting popularity...';
                        } else if (data.current_phase === 'singles') {
                            phaseText = '<i class="bi bi-music-note"></i> Detecting singles & rating...';
                        } else if (data.current_phase === 'navidrome_update') {
                            phaseText = '<i class="bi bi-cloud-upload"></i> Updating Navidrome...';
                        }
                        document.getElementById('progress-phase').innerHTML = phaseText;
                        
                        // Update progress text
                        const progressText = `${data.processed_artists || 0}/${data.total_artists || 0} artists, ` +
                                           `${data.processed_tracks || 0}/${data.total_tracks || 0} tracks`;
                        document.getElementById('progress-text').textContent = progressText;
                    }
                    // Handle MP3 scan
                    else if (scanType === 'mp3_scan') {
                        const progressBar = document.getElementById('progress-bar');
                        const percent = data.scanned_files && data.total_files ? 
                            Math.round((data.scanned_files / data.total_files) * 100) : 0;
                        progressBar.style.width = percent + '%';
                        progressBar.setAttribute('aria-valuenow', percent);
                        
                        document.getElementById('progress-percent').textContent = percent + '%';
                        document.getElementById('current-artist').innerHTML = 
                            `<i class="bi bi-folder"></i> ${data.current_folder || 'Scanning...'}`;
                        document.getElementById('current-album').innerHTML = '';
                        document.getElementById('progress-phase').innerHTML = 
                            '<i class="bi bi-disc"></i> Scanning music files...';
                        document.getElementById('progress-text').textContent = 
                            `${data.scanned_files || 0} files scanned, ${data.matched_files || 0} matched`;
                    }
                    // Handle Navidrome scan
                    else if (scanType === 'navidrome_scan') {
                        const progressBar = document.getElementById('progress-bar');
                        const percent = data.scanned_albums && data.total_albums ? 
                            Math.round((data.scanned_albums / data.total_albums) * 100) : 0;
                        progressBar.style.width = percent + '%';
                        progressBar.setAttribute('aria-valuenow', percent);
                        
                        document.getElementById('progress-percent').textContent = percent + '%';
                        document.getElementById('current-artist').innerHTML = 
                            `<i class="bi bi-person"></i> ${data.current_artist || 'Scanning...'}`;
                        document.getElementById('current-album').innerHTML = 
                            data.current_album ? ` → <i class="bi bi-disc"></i> ${data.current_album}` : '';
                        document.getElementById('progress-phase').innerHTML = 
                            '<i class="bi bi-cloud"></i> Importing from Navidrome...';
                        document.getElementById('progress-text').textContent = 
                            `${data.scanned_albums || 0}/${data.total_albums || 0} albums`;
                    }
                } else {
                    // Hide progress bar when not running
                    container.style.display = 'none';
                }
            })
            .catch(error => console.error('Error fetching scan progress:', error));
    }
    
    // Initial update
    updateScanStatus();
    updateScanProgress();
    updateIndividualScanProgress();
    
    // Load logs and progress for scan cards
    function updateScanLogsAndProgress() {
        // Load track counts for progress calculation
        fetch('/api/track-count')
            .then(response => response.json())
            .then(data => {
                const totalTracks = data.total_tracks || 1;
                
                // Update progress for each scan type
                const scanMappings = {
                    'navidrome': { filled: data.navidrome_filled, container: 'navidrome_scan' },
                    'popularity': { filled: data.popularity_filled, container: 'popularity_scan' },
                    'singles': { filled: data.singles_filled, container: 'singles_scan' },
                    'file_paths': { filled: data.filepath_filled, container: 'mp3_scan' }
                };
                
                for (const [scanType, mapping] of Object.entries(scanMappings)) {
                    const percent = Math.round((mapping.filled / totalTracks) * 100);
                    const progressContainer = document.querySelector(`.scan-progress-container[data-scan-type="${mapping.container}"]`);
                    if (progressContainer && !progressContainer.style.display || progressContainer.style.display === 'none') {
                        // Only update progress bar text if not currently running
                        const progressText = progressContainer.querySelector('.progress-text');
                        if (progressText) {
                            progressText.textContent = percent + '%';
                        }
                        const progressBar = progressContainer.querySelector('.progress-bar');
                        if (progressBar) {
                            progressBar.style.width = percent + '%';
                        }
                        const scanText = progressContainer.querySelector('.scan-progress-text');
                        if (scanText) {
                            scanText.textContent = `${mapping.filled}/${totalTracks} complete`;
                        }
                    }
                }
            })
            .catch(error => console.error('Error fetching track count:', error));
        
        // Load recent log entries
        fetch('/api/scan-logs')
            .then(response => response.json())
            .then(data => {
                for (const [scanType, lines] of Object.entries(data)) {
                    const logsContainer = document.querySelector(`.scan-logs[data-scan-type="${scanType}"]`);
                    if (logsContainer) {
                        if (lines.length > 0) {
                            logsContainer.innerHTML = lines.map(line => {
                                // Extract just the message part if it contains timestamp
                                const match = line.match(/\] (.+)$/);
                                const message = match ? match[1] : line;
                                return `<small class="text-muted d-block text-truncate">${escapeHtml(message)}</small>`;
                            }).join('');
                        } else {
                            logsContainer.innerHTML = '<small class="text-muted d-block">No recent activity</small>';
                        }
                    }
                }
            })
            .catch(error => console.error('Error fetching scan logs:', error));
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Load logs and progress initially
    updateScanLogsAndProgress();
    
    // Refresh logs and progress every 5 seconds
    setInterval(updateScanLogsAndProgress, 5000);
    // Poll scan status every 2 seconds
    setInterval(updateScanStatus, 2000);
    
    // Poll progress every 1 second
    setInterval(updateScanProgress, 1000);
    setInterval(updateIndividualScanProgress, 1000);
});
</script>
{% endblock %}
