{% extends "base.html" %}

{% block title %}Import Spotify Playlist - Sptnr{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h1>
      <i class="bi bi-music-note-list"></i> Import Spotify Playlist
      <a href="/help/FEATURES_PLAYLISTS" class="btn btn-sm btn-outline-success ms-2" title="Help for Playlist Import">
          <i class="bi bi-question-circle"></i>
      </a>
    </h1>
    <p class="text-secondary">Create a Navidrome playlist from a Spotify playlist URL</p>
  </div>
</div>

<!-- Input Section -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Import Playlist</h5>
      </div>
      <div class="card-body">
        <form id="playlistForm" onsubmit="importPlaylist(event)">
          <div class="row g-3">
            <div class="col-12">
              <label for="spotifyUrl" class="form-label">Spotify Playlist URL</label>
              <input 
                type="text" 
                id="spotifyUrl" 
                class="form-control" 
                placeholder="https://open.spotify.com/playlist/..."
                required
              />
              <small class="text-secondary">
                <i class="bi bi-info-circle"></i> 
                Paste a Spotify playlist URL (any format: link, URI, or ID)
              </small>
            </div>
            <div class="col-12 col-md-6">
              <label for="playlistName" class="form-label">Playlist Name</label>
              <input 
                type="text" 
                id="playlistName" 
                class="form-control" 
                placeholder="e.g., My Imported Playlist"
                required
              />
            </div>
            <div class="col-12 col-md-6">
              <label for="playlistDescription" class="form-label">Description (optional)</label>
              <input 
                type="text" 
                id="playlistDescription" 
                class="form-control" 
                placeholder="e.g., Imported from Spotify"
              />
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-download"></i> Import Playlist
              </button>
              <span id="importStatus" class="ms-2 text-secondary"></span>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Your Spotify Playlists Section -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-spotify"></i> Your Spotify Playlists
        </h5>
        <button class="btn btn-sm btn-outline-secondary" id="refreshPlaylistsBtn" onclick="loadSpotifyPlaylists()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-3">
          <i class="bi bi-info-circle"></i> 
          <strong>Note:</strong> To view your personal Spotify playlists, you need to set the <code>SPOTIFY_USER_TOKEN</code> environment variable with your Spotify user access token. 
          Without it, featured public playlists will be shown instead. 
          See the <a href="/help/FEATURES_PLAYLISTS" target="_blank">playlist documentation</a> for authentication setup instructions.
        </div>
        
        <!-- Spotify User ID Input -->
        <div class="mb-3">
          <label for="spotifyUserId" class="form-label">
            <i class="bi bi-person"></i> Browse Another User's Public Playlists
          </label>
          <div class="input-group">
            <input 
              type="text" 
              id="spotifyUserId" 
              class="form-control" 
              placeholder="Enter Spotify User ID (e.g., 'spotify', 'username')"
            />
            <button class="btn btn-outline-primary" type="button" onclick="loadSpotifyPlaylistsByUser()">
              <i class="bi bi-search"></i> Load
            </button>
            <button class="btn btn-outline-secondary" type="button" onclick="clearSpotifyUserId()">
              <i class="bi bi-x-circle"></i> Clear
            </button>
          </div>
          <small class="text-secondary">
            <i class="bi bi-info-circle"></i> 
            Enter a Spotify User ID to view their public playlists. Leave empty to use configured user or featured playlists.
          </small>
        </div>
        
        <div id="playlistsLoading" class="text-center text-muted py-4">
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          Loading Spotify playlists...
        </div>
        <div id="playlistsContainer" style="display: none;">
          <div class="row g-3" id="playlistsGrid">
            <!-- Playlists will be inserted here -->
          </div>
        </div>
        <div id="playlistsError" style="display: none;" class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          <span id="playlistsErrorText">Unable to load playlists. Make sure Spotify is configured in your config file.</span>
        </div>
        <div id="playlistsEmpty" style="display: none;" class="alert alert-info">
          <i class="bi bi-info-circle"></i> 
          <span id="playlistsEmptyText">No playlists found. If you expected to see your personal playlists, make sure <code>SPOTIFY_USER_TOKEN</code> is set.</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results Section -->
<div id="resultsSection" style="display: none;">
  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-12 col-md-3">
      <div class="card text-center bg-success bg-opacity-10 border-success">
        <div class="card-body">
          <h5 class="card-title text-success">Matched</h5>
          <h2 id="matchedCount" class="text-success">0</h2>
          <small class="text-secondary">songs found in library</small>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card text-center bg-warning bg-opacity-10 border-warning">
        <div class="card-body">
          <h5 class="card-title text-warning">Missing</h5>
          <h2 id="missingCount" class="text-warning">0</h2>
          <small class="text-secondary">songs not in library</small>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card text-center bg-info bg-opacity-10 border-info">
        <div class="card-body">
          <h5 class="card-title text-info">Total</h5>
          <h2 id="totalCount" class="text-info">0</h2>
          <small class="text-secondary">tracks in playlist</small>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card text-center bg-secondary bg-opacity-10 border-secondary">
        <div class="card-body">
          <h5 class="card-title text-secondary">Coverage</h5>
          <h2 id="coverage" class="text-secondary">0%</h2>
          <small class="text-secondary">of playlist matched</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Matched Tracks -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-check-circle-fill text-success"></i> Matched Tracks</h5>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-primary" onclick="openAddTrackModal()" title="Manually add a track from the database">
              <i class="bi bi-plus-circle"></i> Add Track
            </button>
            <button class="btn btn-success" onclick="createPlaylist()" id="createPlaylistBtn">
              <i class="bi bi-music-note-list"></i> Create Playlist
            </button>
          </div>
        </div>
        <div class="card-body">
          <p class="text-secondary small mb-3">Create Playlist uses the Navidrome API (no M3U export) and includes only the tracks shown below.</p>
          <div id="matchedTracksContainer" style="max-height: 500px; overflow-y: auto;">
            <!-- Matched tracks will be listed here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Missing Tracks -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-exclamation-circle-fill text-warning"></i> Missing Tracks</h5>
          <small class="text-secondary d-block mt-2">Use the Search or Select buttons to find and download missing tracks. Or manually add tracks to the playlist.</small>
        </div>
        <div class="card-body">
          <div id="missingTracksContainer" style="max-height: 500px; overflow-y: auto;">
            <!-- Missing tracks will be listed here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Track to Playlist Modal -->
<div class="modal fade" id="addTrackModal" tabindex="-1" aria-labelledby="addTrackLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTrackLabel">Manually Add Track to Playlist</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="manualTrackSearch" class="form-label">Search Database</label>
          <div class="input-group">
            <input type="text" class="form-control" id="manualTrackSearch" placeholder="Search by artist, track, or album..." onkeypress="if(event.key==='Enter') searchForTrack();">
            <button class="btn btn-primary" type="button" onclick="searchForTrack()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
        </div>
        
        <div id="trackSearchResults" style="max-height: 400px; overflow-y: auto;">
          <p class="text-muted text-center">Enter a search query to find tracks</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Replace Track Modal -->
<div class="modal fade" id="replaceTrackModal" tabindex="-1" aria-labelledby="replaceTrackLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="replaceTrackLabel"><i class="bi bi-arrow-repeat"></i> Swap Missing Track with Library Track</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Original Track Card -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-warning">
              <div class="card-header bg-warning bg-opacity-10">
                <h6 class="mb-0"><i class="bi bi-music-note"></i> Original Missing Track</h6>
              </div>
              <div class="card-body">
                <div id="originalTrackDisplay" class="track-row">
                  <div class="track-info">
                    <div class="track-title text-warning" id="originalTitle"></div>
                    <div class="track-artist" id="originalArtist"></div>
                    <div class="track-album" id="originalAlbum"></div>
                  </div>
                  <span class="badge bg-warning">Missing from Library</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Arrow -->
        <div class="text-center mb-4">
          <i class="bi bi-arrow-down-circle-fill text-primary" style="font-size: 2rem;"></i>
        </div>

        <!-- Search for Replacement -->
        <div class="mb-3">
          <label class="form-label"><strong>Search Library for Replacement Track</strong></label>
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <input type="text" class="form-control" id="replacementArtistInput" placeholder="Artist" onkeypress="if(event.key==='Enter') searchForReplacementTrack();">
            </div>
            <div class="col-12 col-md-4">
              <input type="text" class="form-control" id="replacementTitleInput" placeholder="Title" onkeypress="if(event.key==='Enter') searchForReplacementTrack();">
            </div>
            <div class="col-12 col-md-4">
              <input type="text" class="form-control" id="replacementAlbumInput" placeholder="Album (optional)" onkeypress="if(event.key==='Enter') searchForReplacementTrack();">
            </div>
          </div>
          <div class="mt-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <small class="text-muted">Provide artist/title to narrow matches; album is optional.</small>
            <button class="btn btn-primary" type="button" onclick="searchForReplacementTrack()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
        </div>
        
        <!-- Replacement Options Card -->
        <div class="card border-success">
          <div class="card-header bg-success bg-opacity-10">
            <h6 class="mb-0"><i class="bi bi-check-circle"></i> Select Replacement from Library</h6>
          </div>
          <div class="card-body">
            <div id="replacementTrackSearchResults" style="max-height: 400px; overflow-y: auto;">
              <p class="text-muted text-center py-4">Enter a search query above to find replacement tracks from your library</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error Section -->
<div id="errorSection" style="display: none;">
  <div class="row">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Error</h5>
        <p id="errorMessage"></p>
      </div>
    </div>
  </div>
</div>

<style>
  .track-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
  }

  .track-row:last-child {
    border-bottom: none;
  }

  .track-info {
    flex: 1;
  }

  .split-col {
    flex: 1;
    min-width: 220px;
  }

  .track-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
  }

  .track-title {
    font-weight: 600;
    color: var(--spotify-green);
    margin-bottom: 0.25rem;
  }

  .track-artist {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .track-album {
    color: var(--text-tertiary);
    font-size: 0.85rem;
  }

  .track-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .missing-track-badge {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
    white-space: nowrap;
  }
  
  .track-actions .btn {
    padding: 0.35rem 0.6rem;
    font-size: 0.85rem;
    min-width: auto;
    white-space: nowrap;
  }
  
  .track-actions .btn i {
    margin-right: 0.25rem;
  }
</style>

<script>
  let currentImportData = null;
  let missingTracksForSearch = [];

  async function importPlaylist(event) {
    event.preventDefault();
    
    const spotifyUrl = document.getElementById('spotifyUrl').value.trim();
    const playlistName = document.getElementById('playlistName').value.trim();
    const playlistDescription = document.getElementById('playlistDescription').value.trim();
    const statusEl = document.getElementById('importStatus');
    
    if (!spotifyUrl || !playlistName) {
      alert('Please fill in all required fields');
      return;
    }
    
    // Show loading state
    statusEl.textContent = '⏳ Importing...';
    statusEl.classList.remove('text-danger');
    statusEl.classList.add('text-secondary');
    
    try {
      const response = await fetch('/api/playlist/import', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          spotify_url: spotifyUrl,
          playlist_name: playlistName,
          playlist_description: playlistDescription
        })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Import failed');
      }
      
      currentImportData = data;
      displayResults(data);
      statusEl.textContent = '✅ Import complete!';
      statusEl.classList.remove('text-secondary', 'text-danger');
      statusEl.classList.add('text-success');
      
      // Store missing tracks for individual search buttons
      if (data.missing_tracks && data.missing_tracks.length > 0) {
        missingTracksForSearch = data.missing_tracks;
      }
    } catch (error) {
      console.error('Error:', error);
      statusEl.textContent = `❌ ${error.message}`;
      statusEl.classList.remove('text-secondary', 'text-success');
      statusEl.classList.add('text-danger');
      
      document.getElementById('errorSection').style.display = 'block';
      document.getElementById('errorMessage').textContent = error.message;
      document.getElementById('resultsSection').style.display = 'none';
    }
  }
  
  function displayResults(data) {
    const matchedCount = data.matched_tracks ? data.matched_tracks.length : 0;
    const missingCount = data.missing_tracks ? data.missing_tracks.length : 0;
    const totalCount = matchedCount + missingCount;
    const coverage = totalCount > 0 ? Math.round((matchedCount / totalCount) * 100) : 0;
    
    // Update summary
    document.getElementById('matchedCount').textContent = matchedCount;
    document.getElementById('missingCount').textContent = missingCount;
    document.getElementById('totalCount').textContent = totalCount;
    document.getElementById('coverage').textContent = coverage + '%';
    
    // Update progress bar color based on coverage
    const coverageEl = document.getElementById('coverage').parentElement.parentElement;
    if (coverage >= 90) {
      coverageEl.classList.remove('bg-warning', 'bg-danger');
      coverageEl.classList.add('bg-success');
    } else if (coverage >= 70) {
      coverageEl.classList.remove('bg-danger', 'bg-success');
      coverageEl.classList.add('bg-warning');
    } else {
      coverageEl.classList.remove('bg-success', 'bg-warning');
      coverageEl.classList.add('bg-danger');
    }
    
    // Display matched tracks (side-by-side playlist vs local)
    const matchedContainer = document.getElementById('matchedTracksContainer');
    if (matchedCount > 0) {
      matchedContainer.innerHTML = data.matched_tracks.map((track, idx) => `
        <div class="track-row">
          <div class="track-info split-col">
            <div class="track-label text-secondary">Playlist Track</div>
            <div class="track-title">${escapeHtml(track.title)}</div>
            <div class="track-artist">${escapeHtml(track.artist)}</div>
            <div class="track-album">${escapeHtml(track.album)}</div>
          </div>
          <div class="track-info split-col border-start ps-3">
            <div class="track-label text-success">Matched in Library</div>
            <div class="track-title text-success">${escapeHtml(track.title)}</div>
            <div class="track-artist">${escapeHtml(track.artist)}</div>
            <div class="track-album">${escapeHtml(track.album)}</div>
            ${track.stars !== undefined ? `<div class="text-muted small">Rating: ${track.stars || 0}★</div>` : ''}
          </div>
          <div class="track-actions">
            <span class="badge bg-success">✓ Found</span>
            <button class="btn btn-sm btn-outline-info" onclick="openReplacementTrackModal('${escapeHtml(track.artist)}', '${escapeHtml(track.title)}', '${escapeHtml(track.album || '')}', 'matched', ${idx})" title="Replace with a different local track">
              <i class="bi bi-arrow-repeat"></i> Replace
            </button>
          </div>
        </div>
      `).join('');
    } else {
      matchedContainer.innerHTML = '<p class="text-secondary text-center py-5">No matched tracks found</p>';
    }
    
    // Display missing tracks
    const missingContainer = document.getElementById('missingTracksContainer');
    if (missingCount > 0) {
      missingContainer.innerHTML = data.missing_tracks.map((track, idx) => `
        <div class="track-row">
          <div class="track-info">
            <div class="track-title">${escapeHtml(track.title)}</div>
            <div class="track-artist">${escapeHtml(track.artist)}</div>
            <div class="track-album">${escapeHtml(track.album || 'Unknown Album')}</div>
          </div>
          <div class="track-actions">
            <span class="missing-track-badge">✗ Missing</span>
            <button class="btn btn-sm btn-outline-success" onclick="searchTrackInSoulseek('${escapeHtml(track.artist + ' ' + track.title)}', this)" title="Search in Soulseek">
              <i class="bi bi-cloud-arrow-down"></i> Search
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="openReplacementTrackModal('${escapeHtml(track.artist)}', '${escapeHtml(track.title)}', '${escapeHtml(track.album || '')}', 'missing', ${idx})" title="Replace with different song">
              <i class="bi bi-arrow-repeat"></i> Replace
            </button>
          </div>
        </div>
      `).join('');
    } else {
      missingContainer.innerHTML = '<p class="text-success text-center py-5">All tracks found in library!</p>';
    }
    
    // Show results section
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('errorSection').style.display = 'none';
  }
  
  async function createPlaylist() {
    if (!currentImportData) return;
    
    const createBtn = document.getElementById('createPlaylistBtn');
    const originalText = createBtn.innerHTML;
    createBtn.disabled = true;
    createBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
    
    try {
      const response = await fetch('/api/playlist/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          playlist_name: currentImportData.playlist_name,
          playlist_description: currentImportData.playlist_description,
          matched_tracks: currentImportData.matched_tracks
        })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Playlist creation failed');
      }
      
      alert(`✅ Playlist "${currentImportData.playlist_name}" created successfully!`);
      createBtn.innerHTML = '<i class="bi bi-check-circle"></i> Playlist Created!';
      createBtn.classList.remove('btn-primary');
      createBtn.classList.add('btn-success');
    } catch (error) {
      alert(`❌ Error: ${error.message}`);
      createBtn.disabled = false;
      createBtn.innerHTML = originalText;
    }
  }
  
  async function searchMissingTracks() {
    if (missingTracksForSearch.length === 0) {
      alert('No missing tracks to search');
      return;
    }
    
    const searchBtn = document.getElementById('searchMissingBtn');
    const originalText = searchBtn.innerHTML;
    searchBtn.disabled = true;
    searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Searching...';
    
    try {
      // Start searches for all missing tracks
      for (const track of missingTracksForSearch) {
        const query = `${track.artist} ${track.title}`;
        
        const response = await fetch('/api/slskd/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ query })
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log(`Started search for: ${query}`, data);
        }
        
        // Small delay between requests
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      alert(`✅ Started searching for ${missingTracksForSearch.length} missing tracks in Soulseek. Check the Downloads page for results!`);
      searchBtn.disabled = false;
      searchBtn.innerHTML = originalText;
    } catch (error) {
      alert(`❌ Error starting searches: ${error.message}`);
      searchBtn.disabled = false;
      searchBtn.innerHTML = originalText;
    }
  }
  
  async function searchTrackInSoulseek(query, buttonEl) {
    const originalText = buttonEl.innerHTML;
    buttonEl.disabled = true;
    buttonEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
      const response = await fetch('/api/slskd/search', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: query.trim() })
      });
      
      if (!response.ok) {
        throw new Error('Search failed');
      }
      
      const data = await response.json();
      buttonEl.innerHTML = '<i class="bi bi-check-circle text-success"></i> Searching...';
      buttonEl.classList.add('btn-success');
      buttonEl.classList.remove('btn-outline-success');
      
      // Poll for results immediately
      setTimeout(() => {
        pollSoulseekResults(data.searchId, query, buttonEl, originalText);
      }, 1000);
    } catch (error) {
      alert(`❌ Error searching for track: ${error.message}`);
      buttonEl.disabled = false;
      buttonEl.innerHTML = originalText;
    }
  }

  async function pollSoulseekResults(searchId, query, buttonEl, originalText) {
    try {
      const response = await fetch(`/api/slskd/search/${searchId}`);
      if (!response.ok) throw new Error('Failed to get results');
      
      const data = await response.json();
      
      if (!data.isComplete) {
        // Still searching, poll again after 2 seconds
        setTimeout(() => {
          pollSoulseekResults(searchId, query, buttonEl, originalText);
        }, 2000);
        return;
      }
      
      // Results are complete
      if (data.fileCount === 0) {
        alert(`⚠️ No results found for: "${query}"`);
        buttonEl.disabled = false;
        buttonEl.innerHTML = originalText;
        return;
      }
      
      // Show modal with results and download options
      showSoulseekResultsModal(data.results, query);
      buttonEl.disabled = false;
      buttonEl.innerHTML = originalText;
    } catch (error) {
      console.error('Error polling results:', error);
      buttonEl.disabled = false;
      buttonEl.innerHTML = originalText;
    }
  }

  function showSoulseekResultsModal(results, query) {
    let html = `
      <div class="modal fade" id="soulseekResultsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Soulseek Results for: ${escapeHtml(query)}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
              <div class="list-group">
    `;
    
    results.forEach((result, idx) => {
      html += `
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">${escapeHtml(result.filename)}</h6>
              <small class="text-muted">
                <i class="bi bi-person"></i> ${escapeHtml(result.username)} | 
                <i class="bi bi-file-earmark-music"></i> ${result.size_mb} MB | 
                <i class="bi bi-speedometer"></i> ${result.bitrate || 'unknown'} bps
              </small>
            </div>
            <button class="btn btn-sm btn-success" onclick="downloadSoulseekFile('${escapeHtml(result.username)}', '${escapeHtml(result.filename)}', '${escapeHtml(result.size)}')">
              <i class="bi bi-download"></i> Download
            </button>
          </div>
        </div>
      `;
    });
    
    html += `
              </div>
            </div>
            <div class="modal-footer">
              <small class="text-muted">Found ${results.length} result(s). Downloads will appear on the Downloads page.</small>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Remove old modal if exists
    const oldModal = document.getElementById('soulseekResultsModal');
    if (oldModal) oldModal.remove();
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', html);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('soulseekResultsModal'));
    modal.show();
  }

  async function downloadSoulseekFile(username, filename, size) {
    try {
      const response = await fetch('/api/slskd/download-single', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: username,
          filename: filename,
          size: parseInt(size)
        })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Download failed');
      }
      
      const data = await response.json();
      alert(`✅ Download started for: ${escapeHtml(filename)}`);
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('soulseekResultsModal'));
      if (modal) modal.hide();
    } catch (error) {
      alert(`❌ Error downloading: ${error.message}`);
    }
  }
  
  function manuallySelectFile(title, artist, buttonEl) {
    // Open search page to browse database for this track
    const searchQuery = `${artist} ${title}`;
    const encodedQuery = encodeURIComponent(searchQuery);
    
    // Store the query in sessionStorage for the search page to use
    sessionStorage.setItem('initialSearchQuery', searchQuery);
    
    // Open search page to browse database
    window.open(`/search?q=${encodedQuery}`, '_blank');
    
    buttonEl.innerHTML = '<i class="bi bi-check-circle text-info"></i> Opening...';
    setTimeout(() => {
      buttonEl.innerHTML = '<i class="bi bi-folder"></i> Select';
    }, 2000);
  }
  
  function openAddTrackModal() {
    if (!currentImportData) {
      alert('Please import a playlist first');
      return;
    }
    const modal = new bootstrap.Modal(document.getElementById('addTrackModal'));
    modal.show();
  }
  
  async function searchForTrack() {
    const query = document.getElementById('manualTrackSearch').value.trim();
    if (!query) {
      alert('Please enter a search query');
      return;
    }
    
    const resultsDiv = document.getElementById('trackSearchResults');
    resultsDiv.innerHTML = '<div class="text-center"><span class="spinner-border spinner-border-sm"></span> Searching...</div>';
    
    try {
      const response = await fetch('/api/search', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: query })
      });
      
      if (!response.ok) {
        const error = await response.text();
        resultsDiv.innerHTML = `<p class="text-danger text-center">Error: ${error}</p>`;
        return;
      }
      
      const data = await response.json();
      
      if (!data.results || data.results.length === 0) {
        resultsDiv.innerHTML = '<p class="text-muted text-center">No tracks found</p>';
        return;
      }
      
      // Filter to tracks only
      const tracks = data.results.filter(r => r.type === 'track');
      
      if (tracks.length === 0) {
        resultsDiv.innerHTML = '<p class="text-muted text-center">No tracks found</p>';
        return;
      }
      
      // Display tracks
      let html = '<div style="border-top: 1px solid var(--border-color);">';
      tracks.forEach(track => {
        html += `
          <div class="track-row" style="padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
            <div class="track-info">
              <div class="track-title">${escapeHtml(track.title)}</div>
              <div class="track-artist">${escapeHtml(track.artist)}</div>
              <div class="track-album">${escapeHtml(track.album || 'Unknown Album')}</div>
            </div>
            <div class="track-actions">
              <button class="btn btn-sm btn-success" onclick="addSelectedTrack('${escapeHtml(track.title)}', '${escapeHtml(track.artist)}', '${escapeHtml(track.album || '')}')"
                      title="Add this track to the playlist">
                <i class="bi bi-plus-circle"></i> Add
              </button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      resultsDiv.innerHTML = html;
    } catch (error) {
      resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
  }
  
  function addSelectedTrack(title, artist, album) {
    if (!currentImportData) {
      alert('No playlist data found');
      return;
    }
    
    // Check if track already exists in matched tracks
    const exists = currentImportData.matched_tracks.some(t => 
      t.title === title && t.artist === artist
    );
    
    if (exists) {
      alert('This track is already in the playlist');
      return;
    }
    
    // Add to matched tracks
    currentImportData.matched_tracks.push({
      title: title,
      artist: artist,
      album: album
    });
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('addTrackModal')).hide();
    
    // Re-display results with updated data
    displayResults(currentImportData);
    
    alert(`✅ Track "${title}" added to playlist!`);
  }
  
  // Replacement track modal functions
  let replacingTrackInfo = null;
  
  function openReplacementTrackModal(artist, title, album, source = 'missing', sourceIndex = null) {
    replacingTrackInfo = { artist, title, album, source, sourceIndex };
    
    // Populate original track display
    document.getElementById('originalTitle').textContent = title;
    document.getElementById('originalArtist').textContent = artist;
    document.getElementById('originalAlbum').textContent = album || 'Unknown Album';
    
    // Pre-populate search fields for easier searching
    document.getElementById('replacementArtistInput').value = artist || '';
    document.getElementById('replacementTitleInput').value = title || '';
    document.getElementById('replacementAlbumInput').value = album || '';
    document.getElementById('replacementTrackSearchResults').innerHTML = '<p class="text-muted text-center py-4">Enter artist/title above to find replacement tracks from your library</p>';
    
    const modal = new bootstrap.Modal(document.getElementById('replaceTrackModal'));
    modal.show();
  }
  
  async function searchForReplacementTrack() {
    const artist = document.getElementById('replacementArtistInput').value.trim();
    const title = document.getElementById('replacementTitleInput').value.trim();
    const album = document.getElementById('replacementAlbumInput').value.trim();

    const combined = [artist, title, album].filter(Boolean).join(' ').trim();
    if (!combined) {
      alert('Please provide at least one search field');
      return;
    }
    
    const resultsDiv = document.getElementById('replacementTrackSearchResults');
    resultsDiv.innerHTML = '<div class="text-center"><span class="spinner-border spinner-border-sm"></span> Searching...</div>';
    
    try {
      const response = await fetch('/api/playlist/search-songs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: combined, artist, title, album })
      });
      
      if (!response.ok) {
        const error = await response.text();
        resultsDiv.innerHTML = `<p class="text-danger text-center">Error: ${error}</p>`;
        return;
      }
      
      const data = await response.json();

      const tracks = data.songs || [];

      if (!tracks || tracks.length === 0) {
        resultsDiv.innerHTML = '<p class="text-muted text-center">No tracks found</p>';
        return;
      }
      
      // Display tracks
      let html = '<div style="border-top: 1px solid var(--border-color);">';
      tracks.forEach(track => {
        html += `
          <div class="track-row" style="padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
            <div class="track-info">
              <div class="track-title text-success">${escapeHtml(track.title)}</div>
              <div class="track-artist">${escapeHtml(track.artist)}</div>
              <div class="track-album">${escapeHtml(track.album || 'Unknown Album')}</div>
            </div>
            <div class="track-actions">
              <button class="btn btn-sm btn-success" onclick="replaceSelectedTrack('${escapeHtml(track.title)}', '${escapeHtml(track.artist)}', '${escapeHtml(track.album || '')}', '${escapeHtml(track.id || '')}')"
                      title="Swap with this track from your library">
                <i class="bi bi-arrow-left-right"></i> Swap with This Track
              </button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      resultsDiv.innerHTML = html;
    } catch (error) {
      resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
  }
  
  function replaceSelectedTrack(title, artist, album, trackId) {
    if (!currentImportData || !replacingTrackInfo) {
      alert('No playlist data found');
      return;
    }

    const { source, sourceIndex } = replacingTrackInfo;

    if (source === 'missing') {
      const missingIndex = currentImportData.missing_tracks.findIndex((t, idx) => 
        idx === sourceIndex || (t.title === replacingTrackInfo.title && t.artist === replacingTrackInfo.artist)
      );
      if (missingIndex !== -1) {
        currentImportData.missing_tracks.splice(missingIndex, 1);
      }
    }

    if (source === 'matched' && sourceIndex !== null && currentImportData.matched_tracks[sourceIndex]) {
      currentImportData.matched_tracks[sourceIndex] = {
        id: trackId,
        title,
        artist,
        album,
        stars: 0
      };
    } else {
      currentImportData.matched_tracks.push({
        id: trackId,
        title,
        artist,
        album,
        stars: 0
      });
    }
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('replaceTrackModal')).hide();
    
    // Re-display results with updated data
    displayResults(currentImportData);
    
    // Show success message with clear before/after
        alert(`✅ Swapped Successfully!\n\n` +
          `Playlist track: "${replacingTrackInfo.artist} - ${replacingTrackInfo.title}"\n` +
          `Now using library track: "${artist} - ${title}"`);
    replacingTrackInfo = null;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load Spotify playlists on page load
  async function loadSpotifyPlaylists(userId = null) {
    const container = document.getElementById('playlistsContainer');
    const loading = document.getElementById('playlistsLoading');
    const error = document.getElementById('playlistsError');
    const empty = document.getElementById('playlistsEmpty');
    const grid = document.getElementById('playlistsGrid');
    const refreshBtn = document.getElementById('refreshPlaylistsBtn');

    loading.style.display = 'block';
    container.style.display = 'none';
    error.style.display = 'none';
    empty.style.display = 'none';
    refreshBtn.disabled = true;

    try {
      // Build URL with optional user_id parameter
      let url = '/api/spotify/playlists';
      if (userId) {
        url += `?user_id=${encodeURIComponent(userId)}`;
      }
      
      const response = await fetch(url);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to load playlists');
      }

      const playlists = data.playlists || [];
      
      // Update header to show which user's playlists are being displayed
      const header = document.querySelector('#playlistsContainer').closest('.card').querySelector('.card-header h5');
      if (data.user_id) {
        header.innerHTML = `<i class="bi bi-spotify"></i> Public Playlists from <span class="badge bg-primary">${escapeHtml(data.user_id)}</span>`;
      } else {
        header.innerHTML = `<i class="bi bi-spotify"></i> Your Spotify Playlists`;
      }

      if (playlists.length === 0) {
        loading.style.display = 'none';
        empty.style.display = 'block';
        document.getElementById('playlistsEmptyText').innerHTML = data.user_id 
          ? `No public playlists found for user <strong>${escapeHtml(data.user_id)}</strong>. Make sure the user ID is correct.`
          : 'No playlists found. If you expected to see your personal playlists, make sure <code>SPOTIFY_USER_TOKEN</code> is set.';
        return;
      }

      // Build playlist cards
      grid.innerHTML = '';
      playlists.forEach(playlist => {
        const card = document.createElement('div');
        card.className = 'col-12 col-sm-6 col-md-4 col-lg-3';
        card.innerHTML = `
          <div class="card h-100 playlist-card">
            ${playlist.image_url ? `<img src="${escapeHtml(playlist.image_url)}" class="card-img-top" alt="${escapeHtml(playlist.name)}" style="height: 150px; object-fit: cover;">` : `<div class="card-img-top bg-secondary" style="height: 150px; display: flex; align-items: center; justify-content: center;"><i class="bi bi-music-note" style="font-size: 2rem; color: white;"></i></div>`}
            <div class="card-body d-flex flex-column">
              <h6 class="card-title text-truncate" title="${escapeHtml(playlist.name)}">${escapeHtml(playlist.name)}</h6>
              ${playlist.owner ? `<small class="text-muted">by ${escapeHtml(playlist.owner)}</small>` : ''}
              <small class="text-muted mt-2">
                <i class="bi bi-music-note-list"></i> ${playlist.track_count} track${playlist.track_count !== 1 ? 's' : ''}
              </small>
              ${playlist.description ? `<small class="text-muted mt-2 text-truncate" title="${escapeHtml(playlist.description)}">${escapeHtml(playlist.description)}</small>` : ''}
              <button class="btn btn-sm btn-primary mt-auto" onclick="importPlaylistFromSpotify('${escapeHtml(playlist.id)}', '${escapeHtml(playlist.name)}')">
                <i class="bi bi-download"></i> Import
              </button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });

      loading.style.display = 'none';
      container.style.display = 'block';
    } catch (err) {
      loading.style.display = 'none';
      error.style.display = 'block';
      document.getElementById('playlistsErrorText').textContent = err.message || 'Unable to load playlists. Make sure Spotify is configured.';
    } finally {
      refreshBtn.disabled = false;
    }
  }
  
  // Load playlists by user ID
  function loadSpotifyPlaylistsByUser() {
    const userId = document.getElementById('spotifyUserId').value.trim();
    if (!userId) {
      alert('Please enter a Spotify User ID');
      return;
    }
    loadSpotifyPlaylists(userId);
  }
  
  // Clear user ID and reload default playlists
  function clearSpotifyUserId() {
    document.getElementById('spotifyUserId').value = '';
    loadSpotifyPlaylists();
  }

  // Import a playlist by clicking the quick import button
  function importPlaylistFromSpotify(playlistId, playlistName) {
    // Set the URL field to the Spotify playlist link
    document.getElementById('spotifyUrl').value = `https://open.spotify.com/playlist/${playlistId}`;
    
    // Set the playlist name
    document.getElementById('playlistName').value = playlistName;
    
    // Scroll to the form
    document.getElementById('spotifyUrl').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Focus and highlight the form
    document.getElementById('spotifyUrl').focus();
    document.getElementById('spotifyUrl').select();
  }

  // Load playlists when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadSpotifyPlaylists();
  });
</script>

{% endblock %}
