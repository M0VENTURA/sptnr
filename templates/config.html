{% extends "base.html" %}
{% block title %}Config · Sptnr{% endblock %}
{% block content %}
<div class="container-fluid py-3 py-md-4">
  <div class="row mb-3">
    <div class="col-12 col-md-auto">
      <h1 class="h3 mb-2">Configuration</h1>
      <p class="text-muted mb-0">Edit settings below or use the setup wizard for guided configuration.</p>
    </div>
    <div class="col-12 col-md-auto ms-md-auto d-flex gap-2 flex-wrap">
      <a href="{{ url_for('setup') }}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-stars"></i> <span class="d-none d-sm-inline">Setup Wizard</span>
      </a>
      <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#rawYamlModal">
        <i class="bi bi-code"></i> <span class="d-none d-sm-inline">Raw YAML</span>
      </button>
    </div>
  </div>

  {% if needs_setup %}
  <div class="alert alert-warning mb-4">
    <strong>First-run setup incomplete:</strong> Some required fields are missing. Please complete setup using the Setup Wizard or fill in all required fields below.
  </div>
  {% endif %}

  <!-- Multi-User Configuration Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0"><i class="bi bi-people-fill"></i> Music Users</h5>
          <small class="text-muted">Configure Navidrome, Spotify, and ListenBrainz for each user</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewUser()">
          <i class="bi bi-plus-circle"></i> Add Another User
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Users Container -->
      <div id="usersContainer">
        {% set navidrome_users = config.get('navidrome_users', []) %}
        {% if navidrome_users %}
          {% for user in navidrome_users %}
          <div class="user-card mb-4 p-3 border rounded" data-user-index="{{ loop.index0 }}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">User {{ loop.index }}: {{ user.get('display_name', user.get('username', 'Unknown')) }}</h6>
              {% if loop.length > 1 %}
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeUser({{ loop.index0 }})">
                <i class="bi bi-trash"></i> Remove
              </button>
              {% endif %}
            </div>
            
            <!-- Navidrome Configuration -->
            <div class="mb-3">
              <h6 class="text-primary mb-2"><i class="bi bi-music-note-beamed"></i> Navidrome</h6>
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label form-label-sm">Display Name</label>
                  <input type="text" class="form-control form-control-sm user-display-name" placeholder="My Name" value="{{ user.get('display_name', '') }}">
                </div>
                <div class="col-12">
                  <label class="form-label form-label-sm">Navidrome Base URL</label>
                  <input type="text" class="form-control form-control-sm user-nav-url" placeholder="http://localhost:4533" value="{{ user.get('base_url', '') }}">
                </div>
                <div class="col-12 col-sm-6">
                  <label class="form-label form-label-sm">Username</label>
                  <input type="text" class="form-control form-control-sm user-nav-username" placeholder="username" value="{{ user.get('user', '') }}">
                </div>
                <div class="col-12 col-sm-6">
                  <label class="form-label form-label-sm">Password</label>
                  <input type="password" class="form-control form-control-sm user-nav-password" placeholder="••••••••" value="{{ user.get('pass', '') }}">
                </div>
              </div>
            </div>
            
            <!-- Spotify Configuration -->
            <div class="mb-3">
              <h6 class="text-success mb-2"><i class="bi bi-spotify"></i> Spotify API</h6>
              <div class="row g-2">
                <div class="col-12 col-sm-6">
                  <label class="form-label form-label-sm">Client ID</label>
                  <input type="text" class="form-control form-control-sm user-spotify-id" placeholder="spotify_client_id" value="{{ user.get('spotify_client_id', '') }}">
                </div>
                <div class="col-12 col-sm-6">
                  <label class="form-label form-label-sm">Client Secret</label>
                  <input type="password" class="form-control form-control-sm user-spotify-secret" placeholder="••••••••" value="{{ user.get('spotify_client_secret', '') }}">
                </div>
              </div>
            </div>
            
            <!-- ListenBrainz Configuration -->
            <div class="mb-3">
              <h6 class="text-info mb-2"><i class="bi bi-database-fill"></i> ListenBrainz API</h6>
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label form-label-sm">User Token</label>
                  <input type="password" class="form-control form-control-sm user-listenbrainz-token" placeholder="listenbrainz_user_token" value="{{ user.get('listenbrainz_user_token', '') }}">
                  <small class="form-text text-muted">Get your token from <a href="https://listenbrainz.org/settings/profile/" target="_blank">ListenBrainz Settings</a></small>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <!-- No users yet, show empty message -->
          <div class="alert alert-info" id="emptyUsersMessage">
            <i class="bi bi-info-circle"></i> No users configured yet. Click "Add Another User" to get started.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- qBittorrent Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <h5 class="mb-0">
        <i class="bi bi-download"></i> qBittorrent
        <span class="float-end">
          <div class="form-check form-switch d-inline-block">
            <input class="form-check-input" type="checkbox" id="qbit_enabled" {% if config.get('qbittorrent', {}).get('enabled') %}checked{% endif %}>
            <label class="form-check-label" for="qbit_enabled">Enabled</label>
          </div>
        </span>
      </h5>
      <small class="text-muted">BitTorrent client for searching and downloading releases</small>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Web URL</label>
          <input type="text" class="form-control" id="qbit_web_url" placeholder="http://localhost:8080" value="{{ config.get('qbittorrent', {}).get('web_url', '') }}">
          <div class="form-text">URL to your qBittorrent Web UI</div>
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label">Username</label>
          <input type="text" class="form-control" id="qbit_username" placeholder="admin" value="{{ config.get('qbittorrent', {}).get('username', '') }}">
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="qbit_password" placeholder="••••••••" value="{{ config.get('qbittorrent', {}).get('password', '') }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Downloads Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <h5 class="mb-0"><i class="bi bi-folder-down"></i> Downloads</h5>
      <small class="text-muted">Download folder configuration</small>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Downloads Folder Path</label>
          <input type="text" class="form-control" id="downloads_folder" placeholder="/downloads/Music" value="{{ config.get('downloads', {}).get('folder', '') }}">
          <div class="form-text">Path where downloaded files are stored. Used for monitoring downloads and building the library.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Soulseek (slskd) Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <h5 class="mb-0">
        <i class="bi bi-cloud-download"></i> Soulseek (slskd)
        <span class="float-end">
          <div class="form-check form-switch d-inline-block">
            <input class="form-check-input" type="checkbox" id="slskd_enabled" {% if config.get('slskd', {}).get('enabled') %}checked{% endif %}>
            <label class="form-check-label" for="slskd_enabled">Enabled</label>
          </div>
        </span>
      </h5>
      <small class="text-muted">P2P music file sharing network</small>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Web URL</label>
          <input type="text" class="form-control" id="slskd_web_url" placeholder="http://localhost:5030" value="{{ config.get('slskd', {}).get('web_url', '') }}">
          <div class="form-text">URL to your slskd Web UI</div>
        </div>
        <div class="col-12">
          <label class="form-label">API Key</label>
          <input type="password" class="form-control" id="slskd_api_key" placeholder="••••••••" value="{{ config.get('slskd', {}).get('api_key', '') }}">
          <div class="form-text">Found in Settings > API</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Authentik SSO Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <h5 class="mb-0">
        <i class="bi bi-shield-lock"></i> Authentik SSO
        <span class="float-end">
          <div class="form-check form-switch d-inline-block">
            <input class="form-check-input" type="checkbox" id="authentik_enabled" {% if config.get('authentik', {}).get('enabled') %}checked{% endif %}>
            <label class="form-check-label" for="authentik_enabled">Enabled</label>
          </div>
        </span>
      </h5>
      <small class="text-muted">Single Sign-On authentication provider</small>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Server URL</label>
          <input type="text" class="form-control" id="authentik_server_url" placeholder="https://auth.example.com" value="{{ config.get('authentik', {}).get('server_url', '') }}">
          <div class="form-text">URL to your Authentik server</div>
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label">Client ID</label>
          <input type="text" class="form-control" id="authentik_client_id" placeholder="client_id" value="{{ config.get('authentik', {}).get('client_id', '') }}">
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label">Client Secret</label>
          <input type="password" class="form-control" id="authentik_client_secret" placeholder="••••••••" value="{{ config.get('authentik', {}).get('client_secret', '') }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Bookmarks Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <h5 class="mb-0">
        <i class="bi bi-bookmark-star"></i> Bookmarks
        <span class="float-end">
          <div class="form-check form-switch d-inline-block">
            <input class="form-check-input" type="checkbox" id="bookmarks_enabled" {% if config.get('bookmarks', {}).get('enabled', True) %}checked{% endif %}>
            <label class="form-check-label" for="bookmarks_enabled">Enabled</label>
          </div>
        </span>
      </h5>
      <small class="text-muted">Quick access to favorite artists, albums, and tracks</small>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Max Bookmarks</label>
          <input type="number" class="form-control" id="bookmarks_max" placeholder="100" value="{{ config.get('bookmarks', {}).get('max_bookmarks', 100) }}" min="1" max="1000">
          <div class="form-text">Maximum number of bookmarks allowed per user</div>
        </div>
        <div class="col-12">
          <label class="form-label">Custom Links</label>
          <div class="form-text mb-2">Add custom links to the Bookmarks dropdown menu</div>
          <div id="customBookmarksList" class="mb-2">
            {% set custom_links = config.get('bookmarks', {}).get('custom_links', []) %}
            {% if custom_links %}
              {% for link in custom_links %}
              <div class="input-group mb-2 bookmark-link-item">
                <input type="text" class="form-control bookmark-link-title" placeholder="Link Title" value="{{ link.title }}">
                <input type="text" class="form-control bookmark-link-url" placeholder="https://example.com" value="{{ link.url }}">
                <button class="btn btn-outline-danger" type="button" onclick="removeBookmarkLink(this)">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
              {% endfor %}
            {% endif %}
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addBookmarkLink()">
            <i class="bi bi-plus-circle"></i> Add Link
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- API Integrations Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <h5 class="mb-0"><i class="bi bi-link-45deg"></i> API Integrations</h5>
      <small class="text-muted">External data sources for music metadata</small>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Spotify -->
        <div class="col-12 border-bottom pb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">Spotify</h6>
              <small class="text-muted d-block">Album, artist, and track data</small>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="spotify_enabled" {% if config.get('api_integrations', {}).get('spotify', {}).get('enabled') %}checked{% endif %}>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-12">
              <label class="form-label form-label-sm">Client ID</label>
              <input type="text" class="form-control form-control-sm" id="spotify_client_id" placeholder="your_spotify_client_id" value="{{ config.get('api_integrations', {}).get('spotify', {}).get('client_id', '') }}">
            </div>
            <div class="col-12">
              <label class="form-label form-label-sm">Client Secret</label>
              <input type="password" class="form-control form-control-sm" id="spotify_client_secret" placeholder="••••••••" value="{{ config.get('api_integrations', {}).get('spotify', {}).get('client_secret', '') }}">
            </div>
          </div>
        </div>

        <!-- Last.fm -->
        <div class="col-12 border-bottom pb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">Last.fm</h6>
              <small class="text-muted d-block">Listening history and user ratings</small>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="lastfm_enabled" {% if config.get('api_integrations', {}).get('lastfm', {}).get('enabled') %}checked{% endif %}>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-12">
              <label class="form-label form-label-sm">API Key</label>
              <input type="text" class="form-control form-control-sm" id="lastfm_api_key" placeholder="your_lastfm_api_key" value="{{ config.get('api_integrations', {}).get('lastfm', {}).get('api_key', '') }}">
            </div>
          </div>
        </div>

        <!-- ListenBrainz -->
        <div class="col-12 border-bottom pb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">ListenBrainz</h6>
              <small class="text-muted d-block">Community music database (public API)</small>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="listenbrainz_enabled" {% if config.get('api_integrations', {}).get('listenbrainz', {}).get('enabled') %}checked{% endif %}>
            </div>
          </div>
        </div>

        <!-- Discogs -->
        <div class="col-12 border-bottom pb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">Discogs</h6>
              <small class="text-muted d-block">Release database and catalog info</small>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="discogs_enabled" {% if config.get('api_integrations', {}).get('discogs', {}).get('enabled') %}checked{% endif %}>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-12">
              <label class="form-label form-label-sm">Token</label>
              <input type="password" class="form-control form-control-sm" id="discogs_token" placeholder="••••••••" value="{{ config.get('api_integrations', {}).get('discogs', {}).get('token', '') }}">
            </div>
          </div>
        </div>

        <!-- MusicBrainz -->
        <div class="col-12 border-bottom pb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">MusicBrainz</h6>
              <small class="text-muted d-block">Music metadata database (public API)</small>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="musicbrainz_enabled" {% if config.get('api_integrations', {}).get('musicbrainz', {}).get('enabled') %}checked{% endif %}>
            </div>
          </div>
        </div>

        <!-- AudioDB -->
        <div class="col-12 border-bottom pb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">AudioDB</h6>
              <small class="text-muted d-block">Album artwork and artist info (optional)</small>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="audiodb_enabled" {% if config.get('api_integrations', {}).get('audiodb', {}).get('enabled') %}checked{% endif %}>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-12">
              <label class="form-label form-label-sm">API Key</label>
              <input type="password" class="form-control form-control-sm" id="audiodb_api_key" placeholder="••••••••" value="{{ config.get('api_integrations', {}).get('audiodb', {}).get('api_key', '') }}">
            </div>
          </div>
        </div>

        <!-- Google -->
        <div class="col-12 border-bottom pb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">Google Custom Search</h6>
              <small class="text-muted d-block">Web search integration</small>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="google_enabled" {% if config.get('api_integrations', {}).get('google', {}).get('enabled') %}checked{% endif %}>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-12 col-sm-6">
              <label class="form-label form-label-sm">API Key</label>
              <input type="password" class="form-control form-control-sm" id="google_api_key" placeholder="••••••••" value="{{ config.get('api_integrations', {}).get('google', {}).get('api_key', '') }}">
            </div>
            <div class="col-12 col-sm-6">
              <label class="form-label form-label-sm">CSE ID</label>
              <input type="password" class="form-control form-control-sm" id="google_cse_id" placeholder="••••••••" value="{{ config.get('api_integrations', {}).get('google', {}).get('cse_id', '') }}">
            </div>
          </div>
        </div>

        <!-- YouTube -->
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">YouTube</h6>
              <small class="text-muted d-block">Video and music search</small>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="youtube_enabled" {% if config.get('api_integrations', {}).get('youtube', {}).get('enabled') %}checked{% endif %}>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-12">
              <label class="form-label form-label-sm">API Key</label>
              <input type="password" class="form-control form-control-sm" id="youtube_api_key" placeholder="••••••••" value="{{ config.get('api_integrations', {}).get('youtube', {}).get('api_key', '') }}">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Database Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <h5 class="mb-0"><i class="bi bi-database"></i> Database</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Database Path</label>
          <input type="text" class="form-control" id="db_path" placeholder="/database/sptnr.db" value="{{ config.get('database', {}).get('path', '') }}">
        </div>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="db_vacuum" {% if config.get('database', {}).get('vacuum_on_start') %}checked{% endif %}>
            <label class="form-check-label" for="db_vacuum">
              Vacuum on start (optimize database file)
            </label>
          </div>
        </div>
      </div>
      <!-- Postgres Migration Section -->
      <hr class="my-4">
      <h5 class="mb-3"><i class="bi bi-arrow-right-circle"></i> Migrate to PostgreSQL</h5>
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Postgres Host</label>
          <input type="text" class="form-control" id="pg_host" placeholder="localhost" value="{{ config.get('PG_HOST', '') }}">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Postgres Port</label>
          <input type="text" class="form-control" id="pg_port" placeholder="5432" value="{{ config.get('PG_PORT', '5432') }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Postgres User</label>
          <input type="text" class="form-control" id="pg_user" placeholder="postgres" value="{{ config.get('PG_USER', '') }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Postgres Password</label>
          <input type="password" class="form-control" id="pg_password" placeholder="••••••••" value="{{ config.get('PG_PASSWORD', '') }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Postgres Database</label>
          <input type="text" class="form-control" id="pg_database" placeholder="sptnr" value="{{ config.get('PG_DATABASE', '') }}">
        </div>
        <div class="col-12">
          <button type="button" class="btn btn-warning btn-lg mt-2" id="migratePostgresBtn" onclick="migrateToPostgres()">
            <i class="bi bi-arrow-right-circle"></i> Migrate to PostgreSQL
          </button>
          <div class="form-text text-danger mt-2">This will copy all data from SQLite to PostgreSQL and update your configuration. This may take several minutes for large databases.</div>
          <div id="pgMigrateMsg" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Logging Section -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-secondary bg-opacity-10 border-bottom">
      <h5 class="mb-0"><i class="bi bi-file-text"></i> Logging</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-sm-6">
          <label class="form-label">Log Level</label>
          <select class="form-select" id="log_level">
            {% set current_level = config.get('logging', {}).get('level', 'INFO') %}
            <option value="DEBUG" {% if current_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
            <option value="INFO" {% if current_level == 'INFO' %}selected{% endif %}>INFO</option>
            <option value="WARNING" {% if current_level == 'WARNING' %}selected{% endif %}>WARNING</option>
            <option value="ERROR" {% if current_level == 'ERROR' %}selected{% endif %}>ERROR</option>
          </select>
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label">Log to Console</label>
          <select class="form-select" id="log_console">
            {% set current_console = config.get('logging', {}).get('console', true) %}
            <option value="true" {% if current_console == true or current_console == 'true' %}selected{% endif %}>Yes</option>
            <option value="false" {% if current_console == false or current_console == 'false' %}selected{% endif %}>No</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Log File Path</label>
          <input type="text" class="form-control" id="log_file" placeholder="/config/app.log" value="{{ config.get('logging', {}).get('file', '') }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Save Button -->
  <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('dashboard') }}'">
      Cancel
    </button>
  </div>
    <button type="button" class="btn btn-primary btn-lg" id="saveBtn" onclick="saveConfig()">
      <i class="bi bi-check-circle"></i> Save Configuration
    </button>
  </div>
  <!-- Toast notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="configToast" class="toast" role="alert">
      <div class="toast-header">
        <i class="bi bi-info-circle me-2"></i>
        <strong class="me-auto" id="toastTitle">Status</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body" id="toastMessage">
        Message
      </div>
    </div>
  </div>
</div>

<!-- Raw YAML Modal -->
<div class="modal fade" id="rawYamlModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-code"></i> Raw YAML Editor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="config_content" class="form-label">config.yaml</label>
        <textarea class="form-control monospace" id="config_content" style="font-family: monospace; font-size: 0.875rem;" rows="24">{{ config_raw }}</textarea>
        <div class="form-text mt-2">Changes are written as-is. Confirm YAML indentation before saving.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveRawYaml()">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
function showToast(title, message, type = 'info') {
  const toast = new bootstrap.Toast(document.getElementById('configToast'));
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastMessage').textContent = message;
  
  const toastEl = document.getElementById('configToast');
  toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning');
  if (type === 'success') toastEl.classList.add('bg-success', 'text-white');
  else if (type === 'error') toastEl.classList.add('bg-danger', 'text-white');
  else if (type === 'warning') toastEl.classList.add('bg-warning', 'text-dark');
  
  toast.show();
}

function buildConfigObject() {
  // Build multi-user array
  const navidrome_users = [];
  const userCards = document.querySelectorAll('.user-card');
  
  userCards.forEach((card, index) => {
    const user = {
      username: card.querySelector('.user-nav-username').value,
      display_name: card.querySelector('.user-display-name').value,
      navidrome_base_url: card.querySelector('.user-nav-url').value,
      navidrome_password: card.querySelector('.user-nav-password').value,
      spotify_client_id: card.querySelector('.user-spotify-id').value,
      spotify_client_secret: card.querySelector('.user-spotify-secret').value,
      listenbrainz_user_token: card.querySelector('.user-listenbrainz-token').value
    };
    
    // Only add user if it has at least username and Navidrome URL
    if (user.username && user.navidrome_base_url) {
      navidrome_users.push(user);
    }
  });
  
  return {
    navidrome_users: navidrome_users,
    qbittorrent: {
      enabled: document.getElementById('qbit_enabled').checked,
      web_url: document.getElementById('qbit_web_url').value,
      username: document.getElementById('qbit_username').value,
      password: document.getElementById('qbit_password').value
    },
    slskd: {
      enabled: document.getElementById('slskd_enabled').checked,
      web_url: document.getElementById('slskd_web_url').value,
      api_key: document.getElementById('slskd_api_key').value
    },
    authentik: {
      enabled: document.getElementById('authentik_enabled').checked,
      server_url: document.getElementById('authentik_server_url').value,
      client_id: document.getElementById('authentik_client_id').value,
      client_secret: document.getElementById('authentik_client_secret').value
    },
    bookmarks: {
      enabled: document.getElementById('bookmarks_enabled').checked,
      max_bookmarks: parseInt(document.getElementById('bookmarks_max').value) || 100,
      custom_links: getCustomBookmarkLinks()
    },
    api_integrations: {
      spotify: {
        enabled: document.getElementById('spotify_enabled').checked,
        client_id: document.getElementById('spotify_client_id').value,
        client_secret: document.getElementById('spotify_client_secret').value
      },
      lastfm: {
        enabled: document.getElementById('lastfm_enabled').checked,
        api_key: document.getElementById('lastfm_api_key').value
      },
      listenbrainz: {
        enabled: document.getElementById('listenbrainz_enabled').checked
      },
      discogs: {
        enabled: document.getElementById('discogs_enabled').checked,
        token: document.getElementById('discogs_token').value
      },
      musicbrainz: {
        enabled: document.getElementById('musicbrainz_enabled').checked
      },
      audiodb: {
        enabled: document.getElementById('audiodb_enabled').checked,
        api_key: document.getElementById('audiodb_api_key').value
      },
      google: {
        enabled: document.getElementById('google_enabled').checked,
        api_key: document.getElementById('google_api_key').value,
        cse_id: document.getElementById('google_cse_id').value
      },
      youtube: {
        enabled: document.getElementById('youtube_enabled').checked,
        api_key: document.getElementById('youtube_api_key').value
      }
    },
    downloads: {
      folder: document.getElementById('downloads_folder').value
    },
    database: {
      path: document.getElementById('db_path').value,
      vacuum_on_start: document.getElementById('db_vacuum').checked
    },
    logging: {
      level: document.getElementById('log_level').value,
      file: document.getElementById('log_file').value,
      console: document.getElementById('log_console').value === 'true'
    }
  };
}

function saveConfig() {
  const saveBtn = document.getElementById('saveBtn');
  saveBtn.disabled = true;
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
  
  const config = buildConfigObject();
  
  fetch('{{ url_for("config_save_json") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(config)
  })
  .then(response => {
    // Check if response is JSON
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      return response.text().then(text => {
        throw new Error('Server returned non-JSON response: ' + text.substring(0, 100));
      });
    }
    return response.json().then(data => ({
      status: response.status,
      data: data
    }));
  })
  .then(result => {
    if (result.status !== 200) {
      showToast('Error', result.data.error || 'Failed to save configuration', 'error');
    } else if (result.data.success) {
      showToast('Success', 'Configuration saved successfully', 'success');
    } else {
      showToast('Error', result.data.error || 'Failed to save configuration', 'error');
    }
  })
  .catch(error => {
    showToast('Error', error.message || 'Network error: ' + error.toString(), 'error');
  })
  .finally(() => {
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
  });
}

function saveRawYaml() {
  const saveBtn = event.target;
  saveBtn.disabled = true;
  const originalText = saveBtn.textContent;
  saveBtn.textContent = 'Saving...';
  
  const configContent = document.getElementById('config_content').value;
  
  const formData = new FormData();
  formData.append('config_content', configContent);
  
  fetch('{{ url_for("config_edit") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.text())
  .then(() => {
    showToast('Success', 'Configuration saved successfully', 'success');
    bootstrap.Modal.getInstance(document.getElementById('rawYamlModal')).hide();
  })
  .catch(error => {
    showToast('Error', 'Network error: ' + error.message, 'error');
  })
  .finally(() => {
    saveBtn.disabled = false;
    saveBtn.textContent = originalText;
  });
}

// Custom Bookmark Link Management Functions
function addBookmarkLink() {
  const container = document.getElementById('customBookmarksList');
  const newItem = document.createElement('div');
  newItem.className = 'input-group mb-2 bookmark-link-item';
  newItem.innerHTML = `
    <input type="text" class="form-control bookmark-link-title" placeholder="Link Title">
    <input type="text" class="form-control bookmark-link-url" placeholder="https://example.com">
    <button class="btn btn-outline-danger" type="button" onclick="removeBookmarkLink(this)">
      <i class="bi bi-trash"></i>
    </button>
  `;
  container.appendChild(newItem);
}

function removeBookmarkLink(button) {
  button.closest('.bookmark-link-item').remove();
}

function getCustomBookmarkLinks() {
  const items = document.querySelectorAll('.bookmark-link-item');
  const links = [];
  items.forEach(item => {
    const title = item.querySelector('.bookmark-link-title').value.trim();
    const url = item.querySelector('.bookmark-link-url').value.trim();
    if (title && url) {
      links.push({ title, url });
    }
  });
  return links;
}

// Multi-User Management Functions
function addNewUser() {
  const container = document.getElementById('usersContainer');
  
  // Hide empty message if it exists
  const emptyMessage = document.getElementById('emptyUsersMessage');
  if (emptyMessage) {
    emptyMessage.remove();
  }
  
  // Get next user index
  const existingCards = container.querySelectorAll('.user-card');
  const userIndex = existingCards.length;
  
  const userCard = document.createElement('div');
  userCard.className = 'user-card mb-4 p-3 border rounded';
  userCard.setAttribute('data-user-index', userIndex);
  userCard.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0">User ${userIndex + 1}: <span class="user-display-value">New User</span></h6>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeUser(${userIndex})">
        <i class="bi bi-trash"></i> Remove
      </button>
    </div>
    
    <!-- Navidrome Configuration -->
    <div class="mb-3">
      <h6 class="text-primary mb-2"><i class="bi bi-music-note-beamed"></i> Navidrome</h6>
      <div class="row g-2">
        <div class="col-12">
          <label class="form-label form-label-sm">Display Name</label>
          <input type="text" class="form-control form-control-sm user-display-name" placeholder="My Name" onchange="updateUserTitle(this)">
        </div>
        <div class="col-12">
          <label class="form-label form-label-sm">Navidrome Base URL</label>
          <input type="text" class="form-control form-control-sm user-nav-url" placeholder="http://localhost:4533">
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label form-label-sm">Username</label>
          <input type="text" class="form-control form-control-sm user-nav-username" placeholder="username">
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label form-label-sm">Password</label>
          <input type="password" class="form-control form-control-sm user-nav-password" placeholder="••••••••">
        </div>
      </div>
    </div>
    
    <!-- Spotify Configuration -->
    <div class="mb-3">
      <h6 class="text-success mb-2"><i class="bi bi-spotify"></i> Spotify API</h6>
      <div class="row g-2">
        <div class="col-12 col-sm-6">
          <label class="form-label form-label-sm">Client ID</label>
          <input type="text" class="form-control form-control-sm user-spotify-id" placeholder="spotify_client_id">
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label form-label-sm">Client Secret</label>
          <input type="password" class="form-control form-control-sm user-spotify-secret" placeholder="••••••••">
        </div>
      </div>
    </div>
    
    <!-- ListenBrainz Configuration -->
    <div class="mb-3">
      <h6 class="text-info mb-2"><i class="bi bi-database-fill"></i> ListenBrainz API</h6>
      <div class="row g-2">
        <div class="col-12">
          <label class="form-label form-label-sm">User Token</label>
          <input type="password" class="form-control form-control-sm user-listenbrainz-token" placeholder="listenbrainz_user_token">
          <small class="form-text text-muted">Get your token from <a href="https://listenbrainz.org/settings/profile/" target="_blank">ListenBrainz Settings</a></small>
        </div>
      </div>
    </div>
  `;
  
  container.appendChild(userCard);
}

function removeUser(idx) {
  // No-op: implement user removal logic if needed
  alert('User removal not yet implemented.');
}

function updateUserTitle(displayNameInput) {
  // Update the user title when display name changes
  const userCard = displayNameInput.closest('.user-card');
  const displayValue = userCard.querySelector('.user-display-value');
  const displayName = displayNameInput.value.trim() || 'New User';
  displayValue.textContent = displayName;
}
</script>

<style>
.form-label-sm {
  font-size: 0.85rem;
  font-weight: 600;
}

.form-control-sm {
  font-size: 0.9rem;
}

.monospace {
  font-family: 'Courier New', monospace !important;
  font-size: 0.875rem;
}

@media (max-width: 576px) {
  .card {
    border: none;
    border-top: 1px solid #dee2e6;
    border-radius: 0;
    box-shadow: none !important;
  }
  
  .card:first-of-type {
    border-top: none;
  }
  
  .card-header {
    padding: 1rem 0 0.5rem 0;
    border: none;
    background: none !important;
  }
  
  .card-body {
    padding: 1rem 0;
  }
  
  h5 {
    font-size: 1rem;
  }
}

/* Dark theme improvements for config page */
.card {
    background-color: var(--secondary-bg) !important;
    border-color: var(--border-color) !important;
}

.card-header {
    background-color: var(--primary-bg) !important;
    border-bottom-color: var(--border-color) !important;
    color: var(--text-primary) !important;
}

.card-body {
    background-color: var(--secondary-bg) !important;
    color: var(--text-primary) !important;
}

.modal-content {
    background-color: var(--secondary-bg) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}

.modal-header {
    background-color: var(--primary-bg) !important;
    border-bottom-color: var(--border-color) !important;
}

.modal-body {
    background-color: var(--secondary-bg) !important;
}
</style>
<script>
function migrateToPostgres() {
  const btn = document.getElementById('migratePostgresBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Migrating...';
  const msg = document.getElementById('pgMigrateMsg');
  msg.innerHTML = '';
  const data = {
    pg_host: document.getElementById('pg_host').value,
    pg_port: document.getElementById('pg_port').value,
    pg_user: document.getElementById('pg_user').value,
    pg_password: document.getElementById('pg_password').value,
    pg_database: document.getElementById('pg_database').value
  };
  fetch('/config/migrate_postgres', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(resp => {
    if (resp.success) {
      msg.innerHTML = '<span class="text-success">Migration successful! Please restart the server to use PostgreSQL.</span>';
    } else {
      msg.innerHTML = '<span class="text-danger">' + (resp.error || 'Migration failed.') + '</span>';
    }
  })
  .catch(function(e) {
    msg.innerHTML = '<span class="text-danger">' + (e && e.message ? e.message : 'Unknown error') + '</span>';
  })
  .finally(function() {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Migrate to PostgreSQL';
  });
}
</script>
{% endblock %}
