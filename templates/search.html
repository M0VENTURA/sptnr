{% extends "base.html" %}

{% block title %}Search Library - Sptnr{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h1><i class="bi bi-search"></i> Search Library</h1>
    <p class="text-secondary">Search for songs, artists, and albums in your Navidrome library</p>
  </div>
</div>

<!-- Search Form -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <form id="searchForm" class="d-flex gap-2" onsubmit="performSearch(event)">
          <input 
            type="text" 
            id="searchQuery" 
            class="form-control" 
            placeholder="Search for artists, albums, or songs..."
            autofocus
          />
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Search Results -->
<div id="searchResults" style="display: none;">
  <!-- Results will be loaded here -->
</div>

<!-- Empty State -->
<div id="emptyState" class="row">
  <div class="col-12">
    <div class="card text-center">
      <div class="card-body py-5">
        <i class="bi bi-search" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; display: block;"></i>
        <h5 class="text-secondary">Start searching</h5>
        <p class="text-tertiary">Enter an artist name, album, or song title to find results</p>
      </div>
    </div>
  </div>
</div>

<style>
  .search-result-card {
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .search-result-card:hover {
    background-color: var(--tertiary-bg);
    border-color: var(--spotify-green);
  }

  .result-type-badge {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .result-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--spotify-green);
    margin-bottom: 0.25rem;
  }

  .result-subtitle {
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .result-meta {
    color: var(--text-tertiary);
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  .result-rating {
    font-size: 0.9rem;
    color: #ffc107;
  }

  .search-loading {
    text-align: center;
    padding: 2rem;
  }

  .search-error {
    padding: 1rem;
  }

  .results-section {
    margin-bottom: 2rem;
  }

  .results-section-title {
    color: var(--spotify-green);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
  }

  @media (max-width: 768px) {
    .results-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Table dark theme styling */
  .table {
    color: var(--text-primary) !important;
    background-color: transparent !important;
  }

  .table thead {
    background-color: var(--primary-bg) !important;
    color: var(--text-primary) !important;
  }

  .table thead th {
    background-color: var(--primary-bg) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }

  .table tbody {
    background-color: transparent !important;
  }

  .table tbody tr {
    background-color: transparent !important;
    border-color: var(--border-color) !important;
  }

  .table tbody td {
    background-color: transparent !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }

  .table tbody td a {
    color: var(--spotify-green) !important;
  }

  .table tbody td a:hover {
    color: var(--text-primary) !important;
  }

  .table tbody td strong {
    color: var(--text-primary) !important;
  }

  .table-hover tbody tr:hover {
    background-color: var(--primary-bg) !important;
    color: var(--text-primary) !important;
  }

  .table-hover tbody tr:hover td {
    background-color: var(--primary-bg) !important;
  }

  .table-responsive {
    background-color: var(--secondary-bg) !important;
  }
</style>

<script>
  async function performSearch(event) {
    event.preventDefault();
    
    const query = document.getElementById('searchQuery').value.trim();
    if (!query) return;
    
    const searchResults = document.getElementById('searchResults');
    const emptyState = document.getElementById('emptyState');
    
    // Show loading state
    searchResults.style.display = 'block';
    emptyState.style.display = 'none';
    searchResults.innerHTML = `
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body search-loading">
              <div class="spinner-border text-success" role="status" style="margin-bottom: 1rem; display: block;">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p>Searching for "${escapeHtml(query)}"...</p>
            </div>
          </div>
        </div>
      </div>
    `;
    
    try {
      const response = await fetch('/api/search', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query })
      });
      
      if (!response.ok) {
        throw new Error(`Search failed: ${response.statusText}`);
      }
      
      const data = await response.json();
      displaySearchResults(data, query);
    } catch (error) {
      searchResults.innerHTML = `
        <div class="row">
          <div class="col-12">
            <div class="card border-danger">
              <div class="card-body search-error">
                <div class="alert alert-danger mb-0">
                  <i class="bi bi-exclamation-circle"></i> 
                  Error: ${escapeHtml(error.message)}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
  }
  
  function displaySearchResults(data, query) {
    const searchResults = document.getElementById('searchResults');
    const emptyState = document.getElementById('emptyState');
    
    const { artists = [], albums = [], tracks = [] } = data;
    const hasResults = artists.length > 0 || albums.length > 0 || tracks.length > 0;
    
    if (!hasResults) {
      searchResults.style.display = 'none';
      emptyState.style.display = 'block';
      emptyState.innerHTML = `
        <div class="row">
          <div class="col-12">
            <div class="card text-center">
              <div class="card-body py-5">
                <i class="bi bi-search" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; display: block;"></i>
                <h5 class="text-secondary">No results found</h5>
                <p class="text-tertiary">No artists, albums, or songs match "${escapeHtml(query)}"</p>
              </div>
            </div>
          </div>
        </div>
      `;
      return;
    }
    
    let html = '';
    
    // Artists section
    if (artists.length > 0) {
      html += `
        <div class="results-section">
          <h5 class="results-section-title">
            <i class="bi bi-people"></i> Artists (${artists.length})
          </h5>
          <div class="results-grid">
            ${artists.map(artist => `
              <div class="card search-result-card" onclick="navigateTo('/artist/${encodeURIComponent(artist.name)}')">
                <div class="card-body">
                  <span class="badge badge-success result-type-badge">Artist</span>
                  <div class="result-title">${escapeHtml(artist.name)}</div>
                  <div class="result-meta">
                    <i class="bi bi-disc"></i> ${artist.album_count} album${artist.album_count !== 1 ? 's' : ''}
                    <br>
                    <i class="bi bi-music-note"></i> ${artist.track_count} track${artist.track_count !== 1 ? 's' : ''}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    // Albums section
    if (albums.length > 0) {
      html += `
        <div class="results-section">
          <h5 class="results-section-title">
            <i class="bi bi-disc"></i> Albums (${albums.length})
          </h5>
          <div class="results-grid">
            ${albums.map(album => `
              <div class="card search-result-card" onclick="navigateTo('/album/${encodeURIComponent(album.artist)}/${encodeURIComponent(album.album)}')">
                <div class="card-body">
                  <span class="badge badge-success result-type-badge">Album</span>
                  <div class="result-title">${escapeHtml(album.album)}</div>
                  <div class="result-subtitle"><i class="bi bi-person"></i> ${escapeHtml(album.artist)}</div>
                  <div class="result-meta">
                    <i class="bi bi-music-note"></i> ${album.track_count} track${album.track_count !== 1 ? 's' : ''}
                    ${album.avg_stars ? `<br><span class="result-rating">★ ${album.avg_stars.toFixed(1)}</span>` : ''}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    // Tracks section
    if (tracks.length > 0) {
      html += `
        <div class="results-section">
          <h5 class="results-section-title">
            <i class="bi bi-music-note"></i> Tracks (${tracks.length})
          </h5>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Artist</th>
                  <th>Album</th>
                  <th class="text-center">Rating</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody>
                ${tracks.map(track => `
                  <tr>
                    <td>
                      <strong>${escapeHtml(track.title)}</strong>
                    </td>
                    <td>
                      <a href="/artist/${encodeURIComponent(track.artist)}" onclick="event.stopPropagation();">
                        ${escapeHtml(track.artist)}
                      </a>
                    </td>
                    <td>
                      <a href="/album/${encodeURIComponent(track.artist)}/${encodeURIComponent(track.album)}" onclick="event.stopPropagation();">
                        ${escapeHtml(track.album)}
                      </a>
                    </td>
                    <td class="text-center">
                      ${track.stars ? `<span class="result-rating">★ ${track.stars}</span>` : '—'}
                    </td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-outline-primary" 
                              onclick="event.stopPropagation(); navigateTo('/track/${encodeURIComponent(track.id)}')">
                        <i class="bi bi-eye"></i> View
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    searchResults.innerHTML = html;
    searchResults.style.display = 'block';
    emptyState.style.display = 'none';
  }
  
  function navigateTo(url) {
    window.location.href = url;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Allow Enter key to trigger search
  document.getElementById('searchQuery').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      performSearch(event);
    }
  });
</script>

{% endblock %}
