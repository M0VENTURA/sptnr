{% extends "base.html" %}

{% block title %}{{ track.title }} - Sptnr{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('artists') }}">Artists</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('artist_detail', name=track.artist) }}">{{ track.artist }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('album_detail', artist=track.artist, album=track.album) }}">{{ track.album }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ track.title }}</li>
        </ol>
    </nav>
    
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-4 gap-2">
        <div class="flex-grow-1">
            <h1 class="h2 mb-1">
                <i class="bi bi-music-note-list"></i> {{ track.title }}
            </h1>
            <p class="text-muted mb-0">by <a href="{{ url_for('artist_detail', name=track.artist) }}">{{ track.artist }}</a></p>
        </div>
        <div class="d-flex gap-2 flex-column flex-md-row w-100 w-md-auto">
            <button class="btn btn-outline-primary" onclick="lookupMetadata('track', '{{ track.id }}')">
                <i class="bi bi-search"></i> <span class="d-none d-sm-inline">MP3 Data</span>
            </button>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Search for this track">
                    <i class="bi bi-download"></i> <span class="d-none d-sm-inline">Download</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    {% if qbit_config.enabled %}
                    <li><a class="dropdown-item" onclick="openQbitSearchTrack('{{ track.artist }}', '{{ track.title }}')" href="javascript:void(0)">
                        <i class="bi bi-cloud-download"></i> Search qBittorrent
                    </a></li>
                    {% endif %}
                    {% if slskd_config.enabled %}
                    <li><a class="dropdown-item" onclick="openSlskdSearchTrack('{{ track.artist }}', '{{ track.title }}')" href="javascript:void(0)">
                        <i class="bi bi-music-note-beamed"></i> Search Soulseek
                    </a></li>
                    {% endif %}
                </ul>
            </div>
            <form method="POST" action="{{ url_for('scan_track_rescan', artist=track.artist, album=track.album, track_id=track.id) }}" class="d-contents">
                <button class="btn btn-outline-info" type="submit" title="Rescan this track (Navidrome + Popularity + Singles)">
                    <i class="bi bi-arrow-repeat"></i> <span class="d-none d-sm-inline">Rescan Track</span>
                </button>
            </form>
        </div>
    </div>    
    <form method="POST" action="{{ url_for('track_edit', track_id=track.id) }}">
        <div class="row g-2 g-md-3">
            <!-- Left Column: Track Info -->
            <div class="col-12 col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-pencil-square"></i> Track Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ track.title }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="artist" class="form-label">Artist</label>
                            <input type="text" class="form-control" id="artist" name="artist" value="{{ track.artist }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="album" class="form-label">Album</label>
                            <input type="text" class="form-control" id="album" name="album" value="{{ track.album }}" required>
                        </div>
                                                <div class="mb-3">
                            <label for="mbid" class="form-label">MusicBrainz ID (MBID)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="mbid" name="mbid" value="{{ track.beets_mbid or track.mbid or '' }}" placeholder="e.g., 579fc21e-40d4-4d72-835c-659e2a4108e4">
                                <button class="btn btn-outline-primary" type="button" onclick="lookupTrackMusicBrainz()">
                                    <i class="bi bi-search"></i> Find
                                </button>
                            </div>
                            <div class="form-text">Official MusicBrainz recording ID</div>
                        </div>
                                                <div class="mb-3">
                            <label for="stars" class="form-label">Rating</label>
                            <select class="form-select" id="stars" name="stars">
                                <option value="0" {% if track.stars == 0 %}selected{% endif %}>☆☆☆☆☆ — 0 Stars</option>
                                <option value="1" {% if track.stars == 1 %}selected{% endif %}>★☆☆☆☆ — 1 Star</option>
                                <option value="2" {% if track.stars == 2 %}selected{% endif %}>★★☆☆☆ — 2 Stars</option>
                                <option value="3" {% if track.stars == 3 %}selected{% endif %}>★★★☆☆ — 3 Stars</option>
                                <option value="4" {% if track.stars == 4 %}selected{% endif %}>★★★★☆ — 4 Stars</option>
                                <option value="5" {% if track.stars == 5 %}selected{% endif %}>★★★★★ — 5 Stars</option>
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="is_single" name="is_single" {% if track.is_single == 1 %}checked{% endif %}>
                            <label class="form-check-label" for="is_single">
                                <i class="bi bi-single-music"></i> Is Single
                            </label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="single_confidence" class="form-label">Single Confidence</label>
                            <select class="form-select" id="single_confidence" name="single_confidence">
                                <option value="low" {% if track.single_confidence == 'low' %}selected{% endif %}>Low</option>
                                <option value="medium" {% if track.single_confidence == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="high" {% if track.single_confidence == 'high' %}selected{% endif %}>High</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Metadata & Info -->
            <div class="col-12 col-lg-6">
                <!-- Scoring Metadata -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up"></i> Scoring Metadata
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="metadata-row">
                            <div class="metadata-label">Track ID</div>
                            <div class="metadata-value monospace" style="font-size: 0.8rem; overflow-wrap: break-word;">{{ track.id }}</div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Spotify</div>
                            <div class="metadata-value">{{ track.spotify_score or '—' }}</div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Last.fm</div>
                            <div class="metadata-value">{{ track.lastfm_ratio or '—' }}</div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">ListenBrainz</div>
                            <div class="metadata-value">{{ track.listenbrainz_score or '—' }}</div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Score</div>
                            <div class="metadata-value">
                                {% if track.score %}
                                    <span class="badge badge-success">{{ track.score|round(3) }}</span>
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                        </div>
                        {% if track.spotify_popularity %}
                        <div class="metadata-row">
                            <div class="metadata-label">Spotify Popularity</div>
                            <div class="metadata-value">{{ track.spotify_popularity }}/100</div>
                        </div>
                        {% endif %}
                        {% if track.lastfm_track_playcount %}
                        <div class="metadata-row">
                            <div class="metadata-label">Last.fm Plays</div>
                            <div class="metadata-value">{{ "{:,}".format(track.lastfm_track_playcount) }}</div>
                        </div>
                        {% endif %}
                        {% if track.spotify_release_age_days %}
                        <div class="metadata-row">
                            <div class="metadata-label">Release Age</div>
                            <div class="metadata-value">{{ track.spotify_release_age_days }} days</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Genres Information -->
                {% if track.genres or track.navidrome_genres or track.spotify_genres or track.lastfm_tags or track.discogs_genres or track.musicbrainz_genres %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-tags-fill"></i> Genre Sources
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if track.genres %}
                        <div class="metadata-row">
                            <div class="metadata-label">Merged Genres</div>
                            <div class="metadata-value">
                                {% for genre in track.genres.split(',') %}
                                    <span class="badge badge-success">{{ genre.strip() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if track.navidrome_genres %}
                        <div class="metadata-row">
                            <div class="metadata-label">Navidrome</div>
                            <div class="metadata-value">
                                {% for genre in track.navidrome_genres.split(',') %}
                                    <span class="badge bg-info">{{ genre.strip() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if track.spotify_genres %}
                        <div class="metadata-row">
                            <div class="metadata-label">Spotify</div>
                            <div class="metadata-value">
                                {% for genre in track.spotify_genres.split(',') %}
                                    <span class="badge bg-success">{{ genre.strip() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if track.lastfm_tags %}
                        <div class="metadata-row">
                            <div class="metadata-label">Last.fm</div>
                            <div class="metadata-value">
                                {% for tag in track.lastfm_tags.split(',') %}
                                    <span class="badge bg-danger">{{ tag.strip() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if track.discogs_genres %}
                        <div class="metadata-row">
                            <div class="metadata-label">Discogs</div>
                            <div class="metadata-value">
                                {% for genre in track.discogs_genres.split(',') %}
                                    <span class="badge bg-warning text-dark">{{ genre.strip() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if track.musicbrainz_genres %}
                        <div class="metadata-row">
                            <div class="metadata-label">MusicBrainz</div>
                            <div class="metadata-value">
                                {% for genre in track.musicbrainz_genres.split(',') %}
                                    <span class="badge bg-primary">{{ genre.strip() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <!-- Beets Metadata (MusicBrainz Recommendations) -->
                {% if track.beets_mbid or track.beets_similarity or track.beets_album_artist %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-database-check"></i> Beets Auto-Import Data
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if track.beets_similarity %}
                        <div class="metadata-row">
                            <div class="metadata-label">Match Confidence</div>
                            <div class="metadata-value">
                                {% if track.beets_similarity >= 0.96 %}
                                    <span class="badge badge-success">{{ (track.beets_similarity * 100)|round(1) }}% — Strong</span>
                                {% elif track.beets_similarity >= 0.75 %}
                                    <span class="badge badge-warning">{{ (track.beets_similarity * 100)|round(1) }}% — Medium</span>
                                {% else %}
                                    <span class="badge badge-danger">{{ (track.beets_similarity * 100)|round(1) }}% — Weak</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% if track.beets_mbid %}
                        <div class="metadata-row">
                            <div class="metadata-label">MusicBrainz Recording</div>
                            <div class="metadata-value">
                                <a href="https://musicbrainz.org/recording/{{ track.beets_mbid }}" target="_blank" class="text-primary text-decoration-none">
                                    {{ track.beets_mbid[:8] }}...
                                    <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.75rem;"></i>
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        {% if track.beets_album_mbid %}
                        <div class="metadata-row">
                            <div class="metadata-label">MusicBrainz Release</div>
                            <div class="metadata-value">
                                <a href="https://musicbrainz.org/release/{{ track.beets_album_mbid }}" target="_blank" class="text-primary text-decoration-none">
                                    {{ track.beets_album_mbid[:8] }}...
                                    <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.75rem;"></i>
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        {% if track.beets_artist_mbid %}
                        <div class="metadata-row">
                            <div class="metadata-label">MusicBrainz Artist</div>
                            <div class="metadata-value">
                                <a href="https://musicbrainz.org/artist/{{ track.beets_artist_mbid }}" target="_blank" class="text-primary text-decoration-none">
                                    {{ track.beets_artist_mbid[:8] }}...
                                    <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.75rem;"></i>
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        {% if track.beets_album_artist %}
                        <div class="metadata-row">
                            <div class="metadata-label">Album Artist (Beets)</div>
                            <div class="metadata-value">{{ track.beets_album_artist }}</div>
                        </div>
                        {% endif %}
                        {% if track.beets_year %}
                        <div class="metadata-row">
                            <div class="metadata-label">Year (Beets)</div>
                            <div class="metadata-value">{{ track.beets_year }}</div>
                        </div>
                        {% endif %}
                        {% if track.beets_import_date %}
                        <div class="metadata-row">
                            <div class="metadata-label">Import Date</div>
                            <div class="metadata-value">
                                <small class="text-muted">{{ track.beets_import_date }}</small>
                            </div>
                        </div>
                        {% endif %}
                        {% if track.beets_path %}
                        <div class="metadata-row">
                            <div class="metadata-label">Beets Path</div>
                            <div class="metadata-value" style="font-size: 0.75rem; overflow-wrap: break-word;">
                                <code class="text-muted">{{ track.beets_path }}</code>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <!-- Audio Metadata -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-disc-fill"></i> Audio Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="metadata-row">
                            <div class="metadata-label">Duration</div>
                            <div class="metadata-value">
                                {% if track.duration %}
                                    {% set mins = (track.duration / 60)|int %}
                                    {% set secs = (track.duration % 60)|int %}
                                    {{ mins }}:{{ "%02d"|format(secs) }}
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Year</div>
                            <div class="metadata-value">{{ track.year or '—' }}</div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Album Artist</div>
                            <div class="metadata-value">
                                {% if track.album_artist %}
                                    <a href="{{ url_for('artist_detail', name=track.album_artist) }}">{{ track.album_artist }}</a>
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Track Number</div>
                            <div class="metadata-value">{{ track.track_number or '—' }}</div>
                        </div>
                        {% if track.disc_number %}
                        <div class="metadata-row">
                            <div class="metadata-label">Disc Number</div>
                            <div class="metadata-value">{{ track.disc_number }}</div>
                        </div>
                        {% endif %}
                        {% if track.stars %}
                        <div class="metadata-row">
                            <div class="metadata-label">Rating</div>
                            <div class="metadata-value">{{ track.stars }}/5</div>
                        </div>
                        {% endif %}
                        {% if track.bpm %}
                        <div class="metadata-row">
                            <div class="metadata-label">BPM</div>
                            <div class="metadata-value">{{ track.bpm }}</div>
                        </div>
                        {% endif %}
                        {% if track.bitrate %}
                        <div class="metadata-row">
                            <div class="metadata-label">Bitrate</div>
                            <div class="metadata-value">{{ (track.bitrate / 1000)|round(0)|int }} kbps</div>
                        </div>
                        {% endif %}
                        {% if track.sample_rate %}
                        <div class="metadata-row">
                            <div class="metadata-label">Sample Rate</div>
                            <div class="metadata-value">{{ (track.sample_rate / 1000)|round(1) }} kHz</div>
                        </div>
                        {% endif %}
                        {% if track.composer %}
                        <div class="metadata-row">
                            <div class="metadata-label">Composer</div>
                            <div class="metadata-value">{{ track.composer }}</div>
                        </div>
                        {% endif %}
                        {% if track.isrc %}
                        <div class="metadata-row">
                            <div class="metadata-label">ISRC</div>
                            <div class="metadata-value monospace" style="font-size: 0.75rem;">{{ track.isrc }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Source & Audit Info -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle"></i> Sources & Audit
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="metadata-row">
                            <div class="metadata-label">File Path</div>
                            <div class="metadata-value">
                                {% if track.beets_path %}
                                    <code style="font-size: 0.75rem; word-break: break-all;">{{ track.beets_path }}</code>
                                {% elif track.file_path %}
                                    <code style="font-size: 0.75rem; word-break: break-all;">{{ track.file_path }}</code>
                                {% else %}
                                    <span class="text-muted">Not available</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Sources</div>
                            <div class="metadata-value">
                                {% if track.single_sources %}
                                    {% for source in track.single_sources.split(',') %}
                                        <span class="badge bg-secondary">{{ source.strip() }}</span>
                                    {% endfor %}
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Canonical</div>
                            <div class="metadata-value">
                                {% if track.is_canonical_title == 1 %}
                                    <span class="badge badge-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Similarity</div>
                            <div class="metadata-value">
                                {% if track.title_similarity_to_base %}
                                    {{ (track.title_similarity_to_base * 100)|round(1) }}%
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Last Scanned</div>
                            <div class="metadata-value">{{ track.last_scanned or 'Never' }}</div>
                        </div>
                        <div class="metadata-row">
                            <div class="metadata-label">Updated By</div>
                            <div class="metadata-value">{{ track.updated_by or '—' }}</div>
                        </div>
                    </div>
                </div>

                <!-- Recommended Genres -->
                {% if recommended_genres %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-tags"></i> Recommended Genres
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-2" style="font-size: 0.85rem;">Based on other {{ track.artist }} tracks in your library</p>
                        <div class="d-flex flex-wrap gap-2">
                            {% for genre in recommended_genres %}
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addGenreToTrack('{{ genre|escape }}')">
                                    <i class="bi bi-plus-circle"></i> {{ genre }}
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- External Metadata Lookups -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-database"></i> External Metadata Lookups
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3" style="font-size: 0.85rem;">Find potential matches from external databases to improve track and genre information</p>
                        
                        <div class="d-grid gap-2 d-md-flex">
                            <button type="button" class="btn btn-outline-info" onclick="lookupMusicBrainz()">
                                <i class="bi bi-search"></i> MusicBrainz Lookup
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="lookupDiscogs()">
                                <i class="bi bi-search"></i> Discogs Lookup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex flex-column flex-md-row gap-2 gap-md-3 mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> Save Changes
            </button>
            <a href="{{ url_for('album_detail', artist=track.artist, album=track.album) }}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
    function addGenreToTrack(genre) {
        // This could update a hidden genres field if you add it to the form
        // For now, just show an alert
        alert('Genre: ' + genre + '\n\nYou can add genre support by adding a genres field to the track editing form.');
    }

    function lookupMusicBrainz() {
        const trackTitle = document.getElementById('title').value;
        const trackArtist = document.getElementById('artist').value;
        
        if (!trackTitle || !trackArtist) {
            alert('Please enter track title and artist');
            return;
        }
        
        fetch('/api/track/musicbrainz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: trackTitle,
                artist: trackArtist
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('externalLookupModal'));
            document.getElementById('lookupTitle').textContent = 'MusicBrainz Lookup Results';
            displayExternalResults(data.results, 'musicbrainz');
            modal.show();
        })
        .catch(error => alert('Network error: ' + error.message));
    }

    function lookupDiscogs() {
        const trackTitle = document.getElementById('title').value;
        const trackArtist = document.getElementById('artist').value;
        const trackAlbum = document.getElementById('album').value;
        
        if (!trackTitle || !trackArtist) {
            alert('Please enter track title and artist');
            return;
        }
        
        fetch('/api/track/discogs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: trackTitle,
                artist: trackArtist,
                album: trackAlbum
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('externalLookupModal'));
            document.getElementById('lookupTitle').textContent = 'Discogs Lookup Results';
            displayExternalResults(data.results, 'discogs');
            modal.show();
        })
        .catch(error => alert('Network error: ' + error.message));
    }

    function displayExternalResults(results, source) {
        const resultsDiv = document.getElementById('externalLookupResults');
        
        if (!results || results.length === 0) {
            resultsDiv.innerHTML = '<div class="alert alert-info">No results found</div>';
            return;
        }
        
        let html = '';
        if (source === 'musicbrainz') {
            results.forEach(result => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">MBID: <code>${result.mbid}</code></h6>
                                    <p class="text-muted mb-0" style="font-size: 0.85rem;">Confidence: ${(result.confidence * 100).toFixed(1)}%</p>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="applyMBID('${result.mbid}', ${result.confidence || 0})">
                                    <i class="bi bi-check-circle"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            results.forEach(result => {
                const genres = (result.genre || []).join(', ');
                const styles = (result.style || []).join(', ');
                html += `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <h6 class="mb-2">${result.title}</h6>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <span class="text-muted" style="font-size: 0.75rem;">Year: </span>
                                    <span>${result.year || '—'}</span>
                                </div>
                                <div class="col-6">
                                    <span class="text-muted" style="font-size: 0.75rem;">Format: </span>
                                    <span>${(result.format || []).join(', ') || '—'}</span>
                                </div>
                            </div>
                            ${genres ? '<p class="mb-2" style="font-size: 0.85rem;"><strong>Genres:</strong> ' + genres + '</p>' : ''}
                            ${styles ? '<p class="mb-2" style="font-size: 0.85rem;"><strong>Styles:</strong> ' + styles + '</p>' : ''}
                            <button class="btn btn-sm btn-primary" onclick="applyDiscogsData('${result.title}', '${genres}')">
                                <i class="bi bi-check-circle"></i> Apply Genres
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        resultsDiv.innerHTML = html;
    }

    function applyMBID(mbid, confidence) {
        // Populate the main MBID field
        const mbidField = document.getElementById('mbid');
        if (!mbidField.value || confirm('Replace current MBID with this suggested one?')) {
            mbidField.value = mbid;
        }
        
        // Close modal and show success
        const modal = bootstrap.Modal.getInstance(document.getElementById('externalLookupModal'));
        if (modal) modal.hide();
        
        alert('✅ MBID applied! Remember to save the form.');
    }

    function applyDiscogsData(title, genres) {
        // In a real implementation, this would update genres in the track record
        alert('Applied Discogs metadata:\nTitle: ' + title + '\nGenres: ' + genres);
    }
</script>

<!-- External Lookup Modal -->
<div class="modal fade" id="externalLookupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lookupTitle">External Lookup Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="externalLookupResults"></div>
            </div>
        </div>
    </div>
</div>

<style>
/* Dark theme improvements for track page */
.card {
    background-color: var(--secondary-bg) !important;
    border-color: var(--border-color) !important;
}

.card-header {
    background-color: var(--primary-bg) !important;
    border-bottom-color: var(--border-color) !important;
    color: var(--text-primary) !important;
}

.card-body {
    background-color: var(--secondary-bg) !important;
    color: var(--text-primary) !important;
}

.table-responsive {
    background-color: var(--secondary-bg) !important;
}

.table {
    color: var(--text-primary) !important;
    background-color: transparent !important;
}

.table thead {
    background-color: var(--primary-bg) !important;
    color: var(--text-primary) !important;
}

.table thead th {
    background-color: var(--primary-bg) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}

.table tbody {
    background-color: transparent !important;
}

.table tbody tr {
    background-color: transparent !important;
    border-color: var(--border-color) !important;
}

.table tbody td {
    background-color: transparent !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}

.table-hover tbody tr:hover {
    background-color: var(--primary-bg) !important;
    color: var(--text-primary) !important;
}

.table-hover tbody tr:hover td {
    background-color: var(--primary-bg) !important;
}
</style>

<script>
function openQbitSearchTrack(artist, title) {
    const query = `${artist} ${title}`;
    window.location.href = `/downloads?search=${encodeURIComponent(query)}`;
}

function openSlskdSearchTrack(artist, title) {
    const query = `${artist} ${title}`;
    window.location.href = `/downloads?search=${encodeURIComponent(query)}`;
}

function lookupTrackMusicBrainz() {
    const title = document.getElementById('title').value;
    const artist = document.getElementById('artist').value;
    
    if (!title || !artist) {
        alert('Please enter both title and artist');
        return;
    }
    
    // Create modal if it doesn't exist
    let modal = document.getElementById('trackMBLookupModal');
    if (!modal) {
        const modalHTML = `
            <div class="modal fade" id="trackMBLookupModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">MusicBrainz Track Lookup</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="trackMBLookupResults">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('trackMBLookupModal');
    }
    
    const resultsDiv = document.getElementById('trackMBLookupResults');
    resultsDiv.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> Searching MusicBrainz...';
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    fetch('/api/track/musicbrainz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: title, artist: artist })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultsDiv.innerHTML = '<div class="alert alert-danger">Error: ' + data.error + '</div>';
            return;
        }
        displayTrackMBResults(data.results);
    })
    .catch(error => {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
    });
}

function displayTrackMBResults(results) {
    const resultsDiv = document.getElementById('trackMBLookupResults');
    
    if (!results || results.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-info">No results found</div>';
        return;
    }
    
    let html = '<div class="list-group">';
    results.forEach(result => {
        const confidencePercent = (result.confidence * 100).toFixed(1);
        const confidenceClass = result.confidence > 0.8 ? 'success' : result.confidence > 0.5 ? 'warning' : 'secondary';
        const duration = result.length ? Math.floor(result.length / 60000) + ':' + String(Math.floor((result.length % 60000) / 1000)).padStart(2, '0') : '';
        
        html += `
            <div class="list-group-item list-group-item-action" style="cursor: pointer; padding: 1rem;">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h6 class="mb-1">${result.title}</h6>
                        <small class="text-muted">by ${result.artist}</small>
                    </div>
                    <span class="badge bg-${confidenceClass}">${confidencePercent}% match</span>
                </div>
                ${result.releases && result.releases.length > 0 ? `
                    <div class="small text-muted mb-2">
                        <strong>Appears on:</strong> ${result.releases.slice(0, 3).map(r => r.title).join(', ')}
                    </div>
                ` : ''}
                ${duration ? `<div class="small text-muted mb-2"><strong>Duration:</strong> ${duration}</div>` : ''}
                <div class="small text-muted mb-2">
                    <strong>MBID:</strong> <code style="font-size: 0.75rem;">${result.mbid}</code>
                </div>
                <button class="btn btn-sm btn-primary" onclick="applyTrackMBID('${result.mbid}', '${result.title}')">
                    <i class="bi bi-check-circle"></i> Select This Match
                </button>
            </div>
        `;
    });
    html += '</div>';
    
    resultsDiv.innerHTML = html;
}

function applyTrackMBID(mbid, title) {
    document.getElementById('mbid').value = mbid;
    const modal = bootstrap.Modal.getInstance(document.getElementById('trackMBLookupModal'));
    modal.hide();
    alert('✅ MBID applied! Remember to save your changes.');
}
</script>
{% endblock %}