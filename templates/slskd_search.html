{% extends "base.html" %}

{% block title %}Soulseek Search · Sptnr{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="mb-4">
    <h1 class="h2 mb-2">
      <i class="bi bi-music-note-beamed"></i> Soulseek Search
    </h1>
    <p class="text-muted mb-0">Search for music files across the Soulseek network</p>
  </div>

  <div class="row g-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="searchQuery" placeholder="Search for music..." autofocus>
            <button class="btn btn-primary" onclick="startSearch()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
          
          <div id="searchStatus" style="display: none;">
            <div class="progress mb-3" style="height: 2px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span id="searchStatusText" class="text-muted">Searching...</span>
              <div>
                <span class="badge bg-secondary" id="responseCount">0 responses</span>
                <span class="badge bg-info" id="resultCount">0 results</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-list"></i> Results
          </h5>
        </div>
        <div class="card-body">
          <div id="noResults" class="alert alert-info">
            <i class="bi bi-info-circle"></i> Enter a search query to get started
          </div>
          
          <div id="resultsContainer" style="display: none;">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Filename</th>
                    <th class="text-center">Size</th>
                    <th class="text-center">Bitrate</th>
                    <th class="text-center">Length</th>
                    <th class="text-center">Action</th>
                  </tr>
                </thead>
                <tbody id="resultsTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentSearchId = null;
let pollInterval = null;
let searchResultsSeen = new Set();

function startSearch() {
  const query = document.getElementById('searchQuery').value.trim();
  
  if (!query) {
    alert('Please enter a search query');
    return;
  }
  
  // Clear previous results
  searchResultsSeen.clear();
  currentSearchId = null;
  
  document.getElementById('noResults').style.display = 'none';
  document.getElementById('resultsContainer').style.display = 'none';
  document.getElementById('searchStatus').style.display = 'block';
  document.getElementById('resultsTable').innerHTML = '';
  document.getElementById('responseCount').textContent = '0 responses';
  document.getElementById('resultCount').textContent = '0 results';
  
  // Start the search
  fetch('/api/slskd/search', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ query: query })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      showError(data.error);
      return;
    }
    
    currentSearchId = data.searchId;
    document.getElementById('searchStatusText').textContent = 'Searching the Soulseek network...';
    
    // Start polling for results
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(pollResults, 500);
    
    // Also poll immediately
    pollResults();
  })
  .catch(error => {
    showError('Network error: ' + error.message);
  });
}

function pollResults() {
  if (!currentSearchId) return;
  
  fetch(`/api/slskd/search/${currentSearchId}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        showError(data.error);
        return;
      }
      
      const results = data.results || [];
      const responseCount = data.responseCount || 0;
      const isComplete = data.isComplete || false;
      const state = data.state || 'Searching';
      
      // Update status
      document.getElementById('responseCount').textContent = responseCount + ' response' + (responseCount !== 1 ? 's' : '');
      document.getElementById('resultCount').textContent = results.length + ' result' + (results.length !== 1 ? 's' : '');
      
      if (isComplete) {
        document.getElementById('searchStatusText').textContent = 'Search completed - ' + state;
        if (pollInterval) clearInterval(pollInterval);
      } else {
        document.getElementById('searchStatusText').textContent = 'Searching... (' + responseCount + ' responses, ' + results.length + ' files)';
      }
      
      // Add new results to table
      if (results.length > 0) {
        document.getElementById('noResults').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'block';
        
        const tbody = document.getElementById('resultsTable');
        
        results.forEach(result => {
          const resultKey = result.username + '|' + result.filename;
          
          if (!searchResultsSeen.has(resultKey)) {
            searchResultsSeen.add(resultKey);
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>
                <strong>${escapeHtml(result.username)}</strong>
              </td>
              <td>
                <div class="text-truncate" style="max-width: 400px;" title="${escapeHtml(result.filename)}">
                  ${escapeHtml(result.filename)}
                </div>
              </td>
              <td class="text-center">${formatBytes(result.size)}</td>
              <td class="text-center">
                ${result.bitrate > 0 ? result.bitrate + ' kbps' : '—'}
              </td>
              <td class="text-center">
                ${result.length > 0 ? formatTime(result.length) : '—'}
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-success" onclick="downloadFile('${escapeHtml(result.username)}', '${escapeHtml(result.filename)}')">
                  <i class="bi bi-download"></i> Download
                </button>
              </td>
            `;
            
            tbody.appendChild(row);
          }
        });
      }
    })
    .catch(error => {
      console.error('Poll error:', error);
    });
}

function downloadFile(username, filename) {
  if (!confirm(`Download "${filename}" from ${username}?`)) return;
  
  fetch('/api/slskd/download', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ username: username, filename: filename })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('✅ Download started! Check the Downloads Monitor to track progress.');
    } else {
      alert('❌ Error: ' + (data.message || 'Failed to start download'));
    }
  })
  .catch(error => {
    alert('❌ Network error: ' + error.message);
  });
}

function showError(message) {
  document.getElementById('searchStatus').style.display = 'none';
  document.getElementById('noResults').style.display = 'block';
  document.getElementById('noResults').innerHTML = `
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle"></i> Error: ${escapeHtml(message)}
    </div>
  `;
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

function formatTime(seconds) {
  if (!seconds) return '0:00';
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;
  
  if (hours > 0) {
    return hours + ':' + String(minutes).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
  }
  return minutes + ':' + String(secs).padStart(2, '0');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Allow Enter key to trigger search
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchQuery');
  if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        startSearch();
      }
    });
  }
});

// Clean up interval when leaving page
window.addEventListener('beforeunload', () => {
  if (pollInterval) clearInterval(pollInterval);
});
</script>

<style>
/* Dark theme improvements for Soulseek search page */
.card {
    background-color: var(--secondary-bg) !important;
    border-color: var(--border-color) !important;
}

.card-header {
    background-color: var(--primary-bg) !important;
    border-bottom-color: var(--border-color) !important;
    color: var(--text-primary) !important;
}

.card-body {
    background-color: var(--secondary-bg) !important;
    color: var(--text-primary) !important;
}

.form-control {
    background-color: var(--primary-bg) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
}

.form-control:focus {
    background-color: var(--primary-bg) !important;
    border-color: var(--spotify-green) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(29, 185, 84, 0.25);
}

.table {
    color: var(--text-primary) !important;
    background-color: var(--secondary-bg) !important;
}

.table thead {
    background-color: var(--primary-bg) !important;
    color: var(--text-primary) !important;
}

.table thead th {
    background-color: var(--primary-bg) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}

.table tbody {
    background-color: var(--secondary-bg) !important;
}

.table tbody tr {
    background-color: var(--secondary-bg) !important;
    border-color: var(--border-color) !important;
}

.table tbody td {
    background-color: var(--secondary-bg) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}

.table-hover tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.05) !important;
    color: var(--text-primary) !important;
}

.table-hover tbody tr:hover td {
    background-color: rgba(255, 255, 255, 0.05) !important;
}

.table-responsive {
    background-color: var(--secondary-bg) !important;
}

.progress {
    background-color: rgba(255, 255, 255, 0.1) !important;
}
</style>

{% endblock %}
